<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MarkCraft - 极简 Markdown 工坊</title>

    <!-- PWA -->
    <meta name="theme-color" content="#171717" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="favicon.ico" />
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Craft" />
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        craft: {
                            black: '#171717',
                            gray: '#f5f5f7',
                            yellow: '#facc15',
                            border: '#e5e5e5',
                            text: '#1d1d1f',
                            card: '#ffffff'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Menlo', 'monospace'],
                    },
                    animation: {
                        'blur-in': 'blurIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-down': 'slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        blurIn: { '0%': { filter: 'blur(12px)', opacity: '0', transform: 'scale(0.98)' }, '100%': { filter: 'blur(0)', opacity: '1', transform: 'scale(1)' } },
                        scaleIn: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        slideDown: { '0%': { transform: 'translateY(-100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    
    <!-- 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath@1.0.0/texmath.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #f5f5f7; color: #1d1d1f; overflow: hidden; -webkit-font-smoothing: antialiased; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 4px; }

        .editor-font { font-family: 'JetBrains Mono', monospace; font-size: 15px; line-height: 1.7; }
        #editor { padding: 1rem 2rem; padding-bottom: 50vh; }
        #editor::selection { background: #facc15; color: black; }
        
        .markdown-body { line-height: 1.8; color: inherit; padding-bottom: 80px; }
        .markdown-body h1 { font-size: 2em; font-weight: 800; margin-bottom: 1rem; border-bottom: 3px solid #facc15; display: inline-block; padding-bottom: 4px; }
        .markdown-body h2 { font-size: 1.5em; font-weight: 700; margin-top: 2rem; margin-bottom: 0.8rem; }
        .markdown-body pre { border-radius: 12px; padding: 1rem; overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,0.05); background: #f9fafb; font-size: 0.9em; }
        .markdown-body blockquote { border-left: 4px solid #facc15; padding: 0.5rem 1rem; margin-bottom: 1rem; background: rgba(250, 204, 21, 0.05); border-radius: 0 8px 8px 0; font-style: italic; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1.5rem; }
        .markdown-body th, .markdown-body td { border: 1px solid #e5e5e5; padding: 8px; }

        #toast { position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #171717; color: white; padding: 10px 20px; border-radius: 99px; font-size: 13px; font-weight: 500; box-shadow: 0 10px 20px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; z-index: 10000; opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* AI Feedback Alert */
        #aiFeedback { 
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-200%);
            width: 90%; max-width: 480px;
            background: rgba(255,255,255,0.98); backdrop-filter: blur(16px);
            border: 1px solid #e5e5e5; border-radius: 20px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15);
            padding: 20px; z-index: 9000;
            display: flex; gap: 16px; align-items: start;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0; pointer-events: none;
        }
        #aiFeedback.show { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }

        dialog { border: none; outline: none; background: transparent; padding: 0; max-width: 100vw; max-height: 100vh; }
        dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); transition: all 0.3s; }
        
        .mobile-only { display: flex; }
        .desktop-only { display: none; }
        .pane { flex: 1; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .pane.hidden-on-mobile { display: none; }

        @media (min-width: 768px) {
            .mobile-only { display: none !important; }
            .desktop-only { display: flex !important; }
            .pane.hidden-on-mobile { display: flex !important; }
            .markdown-body { padding-bottom: 40px; }
        }

        #ai-settings-panel { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        #ai-settings-panel.open { max-height: 500px; opacity: 1; }

        /* Context Menu */
        #context-menu {
            position: absolute; z-index: 1000; background: white; border: 1px solid #e5e5e5;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 6px;
            display: none; min-width: 160px;
        }
        .ctx-item {
            padding: 8px 12px; font-size: 13px; color: #1d1d1f; cursor: pointer; border-radius: 8px;
            display: flex; align-items: center; gap: 8px; font-weight: 500;
        }
        .ctx-item:hover { background: #f5f5f7; }
        .ctx-item i { width: 16px; height: 16px; color: #666; }
        .ctx-divider { height: 1px; background: #e5e5e5; margin: 4px 0; }
        .ctx-item.disabled { opacity: 0.5; cursor: not-allowed; }
        
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            @page { size: auto; margin: 20mm; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col relative bg-craft-gray text-craft-text selection:bg-craft-yellow selection:text-black">
    <a
        href="index.html"
        class="fixed z-[9999] flex items-center gap-2 px-3 py-2 rounded-full bg-black/60 text-white backdrop-blur-md border border-white/10 shadow-lg hover:bg-black/70 active:scale-95 transition"
        style="left: calc(env(safe-area-inset-left) + 16px); bottom: calc(env(safe-area-inset-bottom) + 16px);"
        aria-label="返回 Craft Family 主页"
    >
        <span class="text-sm leading-none">⌂</span>
        <span class="text-xs font-bold">返回主页</span>
    </a>

    <div id="print-area" class="markdown-body hidden"></div>

    <div id="toast">
        <i data-lucide="check-circle" class="w-4 h-4 text-craft-yellow"></i>
        <span id="toast-msg">Success</span>
    </div>

    <!-- AI Feedback Alert (Post-Generation) -->
    <div id="aiFeedback">
        <div class="w-10 h-10 rounded-full bg-craft-yellow/20 flex items-center justify-center shrink-0 text-craft-black">
            <i data-lucide="sparkles" class="w-5 h-5"></i>
        </div>
        <div class="flex-1">
            <h4 class="text-sm font-bold text-craft-black mb-1">润色完成</h4>
            <div class="text-xs text-gray-500 leading-relaxed font-medium mb-3">
                AI 仅修复了格式和公式。如果润色结果仍不满意（例如公式仍有乱码），建议启用 <strong>手动模式</strong> 调用更强模型。
            </div>
            <button onclick="openManualGuide(); closeModal('aiFeedback')" class="text-xs font-bold text-white bg-craft-black px-4 py-2 rounded-lg hover:opacity-90 transition-opacity shadow-sm">
                启用手动模式
            </button>
        </div>
        <button onclick="closeAiFeedback()" class="text-gray-300 hover:text-black transition-colors p-1">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="ctx-item" onclick="insertSyntax('# ', '')"><i data-lucide="heading-1"></i> 一级标题 (H1)</div>
        <div class="ctx-item" onclick="insertSyntax('## ', '')"><i data-lucide="heading-2"></i> 二级标题 (H2)</div>
        <div class="ctx-item" onclick="insertSyntax('**', '**')"><i data-lucide="bold"></i> 加粗</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="insertMathFormula()"><i data-lucide="sigma"></i> 插入公式 ($$)</div>
        <div class="ctx-item" onclick="insertCodeBlock()"><i data-lucide="code"></i> 代码块</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="clearFormatting()"><i data-lucide="eraser"></i> 清除格式</div>
        <div id="ctx-ai-btn" class="ctx-item disabled" onclick="aiBeautifySelection()"><i data-lucide="wand-2"></i> AI 润色选中</div>
    </div>

    <!-- Export Result -->
    <div id="exportResultOverlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-white/80 backdrop-blur-md hidden opacity-0 transition-opacity duration-300">
        <div id="exportResult" class="relative bg-white rounded-[32px] shadow-2xl p-8 max-w-xs w-full text-center transform scale-95 transition-transform duration-300">
            <div class="w-20 h-20 bg-craft-black rounded-2xl flex items-center justify-center mx-auto shadow-lg mb-4 text-craft-yellow">
                <i id="exportIcon" data-lucide="file-check" class="w-10 h-10"></i>
            </div>
            <h3 class="text-lg font-bold text-craft-black">导出成功</h3>
            <p id="exportFilename" class="text-xs text-gray-400 font-mono mt-1 mb-6 truncate">filename.pdf</p>
            <div class="grid grid-cols-2 gap-3">
                 <button onclick="closeExportResult()" class="py-3 rounded-xl border border-gray-200 text-gray-500 font-bold text-xs hover:bg-gray-50">关闭</button>
                 <button onclick="triggerDownload()" class="py-3 rounded-xl bg-craft-black text-white font-bold text-xs hover:bg-gray-800 shadow-md">下载文件</button>
            </div>
        </div>
    </div>

    <!-- Guide Overlay -->
    <div id="guide-overlay" class="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 transition-all duration-500 bg-black/40 backdrop-blur-sm">
        <div id="guide-modal" class="bg-white rounded-t-[32px] md:rounded-[32px] shadow-2xl w-full max-w-md overflow-hidden relative animate-slide-up md:animate-float">
            <div class="p-8 md:p-10 text-center">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 md:hidden"></div>
                <div class="space-y-6">
                    <div class="w-20 h-20 bg-craft-black rounded-2xl flex items-center justify-center mx-auto shadow-xl">
                        <svg width="40" height="40" viewBox="0 0 100 100" fill="none"><path d="M20 80V20H35L50 50L65 20H80V80H70V35L55 65H45L30 35V80H20Z" fill="white"/></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-craft-black mb-2">MarkCraft v4.2</h2>
                        <p class="text-gray-500 text-sm">无损格式修复 • 智能公式识别 • 极简创作</p>
                    </div>
                    <button onclick="enterApp()" class="w-full py-3.5 bg-craft-black text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition-all active:scale-95 shadow-lg">开始创作</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="flex-1 flex flex-col h-full overflow-hidden blur-active">
        
        <!-- Desktop Header -->
        <header class="desktop-only h-16 items-center justify-between px-6 shrink-0 bg-white/80 backdrop-blur-md border-b border-craft-border z-40">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-craft-black rounded-lg flex items-center justify-center text-white"><svg width="16" height="16" viewBox="0 0 100 100" fill="none"><path d="M20 80V20H35L50 50L65 20H80V80H70V35L55 65H45L30 35V80H20Z" fill="white"/></svg></div>
                <span class="font-bold text-sm tracking-tight">MarkCraft</span>
            </div>
            <div class="flex items-center gap-3">
                <!-- Direct AI Action Button -->
                <button onclick="aiBeautify()" class="flex items-center gap-2 px-3 py-1.5 text-xs font-bold bg-gray-100 hover:bg-craft-black hover:text-white rounded-lg transition-colors" title="一键 AI 智能润色全文 (自动修复公式)">
                    <i data-lucide="wand-2" class="w-3 h-3"></i> AI 润色
                </button>
                
                <div class="h-4 w-px bg-gray-200"></div>
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="exportImage()" class="p-2 hover:bg-white hover:shadow-sm rounded-lg text-gray-500" title="导出为长图 (PNG)"><i data-lucide="image" class="w-4 h-4"></i></button>
                    <button onclick="downloadMarkdown()" class="p-2 hover:bg-white hover:shadow-sm rounded-lg text-gray-500" title="导出为 Markdown (.md)"><i data-lucide="file-code" class="w-4 h-4"></i></button>
                    <button onclick="exportWord()" class="p-2 hover:bg-white hover:shadow-sm rounded-lg text-gray-500 hover:text-blue-600" title="导出为 Word 文档 (.doc)"><i data-lucide="file-type-2" class="w-4 h-4"></i></button>
                    <button onclick="openPdfOptions()" class="p-2 hover:bg-white hover:shadow-sm rounded-lg text-gray-500" title="导出为 PDF 文档"><i data-lucide="file-down" class="w-4 h-4"></i></button>
                </div>
                <button onclick="openSettingsModal()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-500" title="设置与 AI 配置"><i data-lucide="settings" class="w-4 h-4"></i></button>
            </div>
        </header>

        <!-- Mobile Header -->
        <header class="mobile-only h-14 flex items-center justify-center px-4 shrink-0 bg-white/90 backdrop-blur-md border-b border-craft-border z-40 relative">
            <div class="flex bg-gray-100 p-1 rounded-xl w-48">
                <button id="tab-edit" onclick="switchMobileTab('edit')" class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-all bg-white text-black shadow-sm">编辑</button>
                <button id="tab-view" onclick="switchMobileTab('view')" class="flex-1 py-1.5 text-xs font-bold rounded-lg transition-all text-gray-500">预览</button>
            </div>
            <button onclick="openSettingsModal()" class="absolute right-4 p-2 text-gray-400"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </header>

        <!-- Workspace -->
        <main class="flex-1 flex md:flex-row overflow-hidden relative">
            
            <!-- Editor Pane -->
            <div id="pane-edit" class="pane">
                <div class="w-full h-full p-3 md:p-6 flex flex-col">
                    <!-- Word-like Toolbar -->
                    <div class="w-full bg-white shadow-sm rounded-t-2xl border-b border-gray-100 p-2 flex items-center gap-1 overflow-x-auto no-scrollbar shrink-0">
                        <button onclick="insertSyntax('**', '**')" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="加粗"><i data-lucide="bold" class="w-4 h-4"></i></button>
                        <button onclick="insertSyntax('*', '*')" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="斜体"><i data-lucide="italic" class="w-4 h-4"></i></button>
                        <button onclick="clearFormatting()" class="p-2 rounded hover:bg-gray-100 text-gray-600 hover:text-red-500" title="清除格式 (橡皮擦)"><i data-lucide="eraser" class="w-4 h-4"></i></button>
                        <div class="w-px h-4 bg-gray-200 mx-1"></div>
                        <button onclick="insertSyntax('# ', '')" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="一级标题"><i data-lucide="heading-1" class="w-4 h-4"></i></button>
                        <button onclick="insertSyntax('## ', '')" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="二级标题"><i data-lucide="heading-2" class="w-4 h-4"></i></button>
                        <div class="w-px h-4 bg-gray-200 mx-1"></div>
                        <button onclick="insertMathFormula()" class="p-2 rounded hover:bg-gray-100 text-craft-yellow font-bold" title="插入公式"><i data-lucide="sigma" class="w-4 h-4"></i></button>
                        <button onclick="insertCodeBlock()" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="代码块"><i data-lucide="code" class="w-4 h-4"></i></button>
                        <button onclick="insertSyntax('> ', '')" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="引用"><i data-lucide="quote" class="w-4 h-4"></i></button>
                        <div class="w-px h-4 bg-gray-200 mx-1"></div>
                        <button onclick="insertSyntax('- ', '')" class="p-2 rounded hover:bg-gray-100 text-gray-600" title="列表"><i data-lucide="list" class="w-4 h-4"></i></button>
                    </div>
                    
                    <div class="w-full flex-1 bg-white shadow-sm rounded-b-2xl relative overflow-hidden border border-t-0 border-gray-100/50">
                         <textarea id="editor" class="editor-font placeholder-gray-300 w-full h-full bg-transparent outline-none resize-none" placeholder="在此输入..." spellcheck="false"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Divider -->
            <div class="desktop-only w-px bg-craft-border z-10 my-6"></div>
            
            <!-- Preview Pane -->
            <div id="pane-view" class="pane hidden-on-mobile">
                <div class="w-full h-full overflow-y-auto p-3 md:p-6 custom-scrollbar">
                    <div id="preview" class="preview-wrapper markdown-body min-h-full w-full p-6 md:p-10 bg-white shadow-sm rounded-2xl border border-gray-100/50"></div>
                    <div class="h-20 md:h-8"></div>
                </div>
            </div>
        </main>

        <!-- Mobile Dock -->
        <div class="mobile-only fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-craft-black/90 backdrop-blur-xl text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-6 animate-slide-up">
            <button onclick="aiBeautify()" class="flex flex-col items-center gap-0.5 group"><i data-lucide="wand-2" class="w-5 h-5 text-craft-yellow"></i></button>
            <div class="w-px h-4 bg-white/20"></div>
            <button onclick="exportWord()" class="opacity-70 hover:opacity-100"><i data-lucide="file-type-2" class="w-5 h-5"></i></button>
            <button onclick="openPdfOptions()" class="opacity-70 hover:opacity-100"><i data-lucide="file-down" class="w-5 h-5"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Manual Guide Modal (Updated) -->
    <dialog id="manualGuideModal" class="m-auto">
        <div class="w-full max-w-md min-w-[340px] bg-white rounded-[32px] shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-white z-10 shrink-0">
                <h3 class="text-lg font-bold text-craft-black flex items-center gap-2">
                    <i data-lucide="book-open" class="w-5 h-5 text-craft-yellow"></i> AI 手动模式指南
                </h3>
                <button onclick="closeModal('manualGuideModal')" class="text-gray-400 hover:text-black transition-colors rounded-full p-1 hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar space-y-8">
                <!-- Step 1 -->
                <div class="flex gap-4">
                    <div class="w-8 h-8 rounded-full bg-craft-black text-white flex items-center justify-center font-bold shrink-0 shadow-md">1</div>
                    <div class="space-y-2 flex-1">
                        <h4 class="font-bold text-sm text-craft-black">复制专用提示词</h4>
                        <p class="text-xs text-gray-500">此提示词已优化，强制 AI 仅修复公式和格式，**绝不修改原文内容**。</p>
                        <button onclick="copyManualPrompt()" class="w-full py-3 rounded-xl border border-gray-200 text-xs font-bold text-gray-600 hover:bg-gray-50 hover:text-black flex items-center justify-center gap-2 transition-colors group">
                            <i data-lucide="copy" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> 复制提示词与文本
                        </button>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="flex gap-4">
                    <div class="w-8 h-8 rounded-full bg-craft-black text-white flex items-center justify-center font-bold shrink-0 shadow-md">2</div>
                    <div class="space-y-2 flex-1">
                        <h4 class="font-bold text-sm text-craft-black">发送给 AI</h4>
                        <p class="text-xs text-gray-500">推荐使用腾讯元宝，它对中文公式处理极佳。</p>
                        <a href="https://yuanbao.tencent.com/" target="_blank" class="block w-full py-3 rounded-xl bg-blue-50 text-blue-600 text-xs font-bold text-center hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                            打开腾讯元宝 <i data-lucide="external-link" class="w-3 h-3"></i>
                        </a>
                    </div>
                </div>

                <!-- Step 3 (Visual Critical Step) -->
                <div class="flex gap-4">
                    <div class="w-8 h-8 rounded-full bg-craft-yellow text-black flex items-center justify-center font-bold shrink-0 shadow-md ring-2 ring-white">3</div>
                    <div class="space-y-3 flex-1">
                        <h4 class="font-bold text-sm text-craft-black">回填结果（关键）</h4>
                        
                        <!-- Important Warning Box -->
                        <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 text-xs text-orange-900 leading-relaxed relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1 h-full bg-orange-400"></div>
                            <div class="flex gap-2 items-start mb-1.5">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-orange-600 shrink-0"></i>
                                <span class="font-bold">非常重要：</span>
                            </div>
                            <p class="opacity-90">
                                务必获取 **Markdown 源码**！
                                <br/>请点击回答框<strong>左下角</strong>复制按钮旁的 <i data-lucide="chevron-down" class="w-3 h-3 inline align-middle"></i> <strong>小箭头</strong>，然后选择 <span class="bg-white px-1.5 py-0.5 rounded border border-orange-200 font-bold text-orange-800 text-[10px] shadow-sm">复制 Markdown</span>。
                            </p>
                            <p class="mt-2 opacity-75 font-medium">❌ 不要直接点击“复制”或选中文字，那样可能丢失公式格式。</p>
                        </div>

                        <!-- Visual Guide (CSS Mockup) -->
                        <div class="rounded-xl border border-gray-200 bg-gray-50 p-4 relative overflow-hidden h-32 flex flex-col justify-end">
                            <!-- Mock AI Response Bubble -->
                            <div class="absolute top-3 left-3 right-3 bg-white rounded-lg border border-gray-200 p-3 shadow-sm opacity-50">
                                <div class="w-3/4 h-2 bg-gray-100 rounded mb-2"></div>
                                <div class="w-1/2 h-2 bg-gray-100 rounded"></div>
                            </div>
                            
                            <!-- Mock Bottom Actions Bar (Focus Area) -->
                            <div class="relative z-10 flex items-center gap-2 mt-auto ml-1">
                                <div class="bg-white border border-gray-300 rounded flex items-center shadow-sm group">
                                    <div class="px-2 py-1 text-[10px] text-gray-500 border-r border-gray-200 flex items-center gap-1">
                                        <i data-lucide="copy" class="w-3 h-3"></i> 复制
                                    </div>
                                    <div class="px-1.5 py-1 hover:bg-blue-50 cursor-pointer bg-blue-50/50">
                                        <i data-lucide="chevron-down" class="w-3 h-3 text-blue-600"></i>
                                    </div>
                                </div>
                                
                                <!-- Mock Menu Popover -->
                                <div class="absolute bottom-full left-8 mb-1 bg-white border border-blue-200 rounded-lg shadow-xl p-1 z-20 animate-scale-in">
                                    <div class="px-2 py-1.5 text-[10px] font-bold text-blue-600 bg-blue-50 rounded flex items-center gap-1 whitespace-nowrap">
                                        <i data-lucide="check" class="w-3 h-3"></i> 复制 Markdown
                                    </div>
                                    <div class="px-2 py-1.5 text-[10px] text-gray-400">复制纯文本</div>
                                </div>
                                
                                <!-- Pointer Hand -->
                                <div class="absolute top-4 left-12 z-30">
                                    <i data-lucide="mouse-pointer-2" class="w-5 h-5 text-craft-black fill-white drop-shadow-md"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-100 bg-gray-50">
                <button onclick="closeModal('manualGuideModal'); editor.focus(); showToast('请粘贴 Markdown 源码');" class="w-full py-3.5 bg-craft-black text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="clipboard-check" class="w-4 h-4"></i> 我已复制源码，粘贴回填
                </button>
            </div>
        </div>
    </dialog>

    <!-- Settings Modal -->
    <dialog id="settingsModal" class="m-auto">
        <div class="w-full max-w-sm min-w-[320px] bg-white rounded-[32px] shadow-2xl overflow-hidden animate-scale-in flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-craft-black">设置</h3>
                <button onclick="closeModal('settingsModal')" class="text-gray-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 space-y-8 overflow-y-auto custom-scrollbar">
                <!-- Theme Section -->
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 block">纸张风格</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="setPaper('white')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-gray-200 hover:border-craft-black hover:bg-gray-50 transition-all text-left group">
                            <div class="w-8 h-8 rounded-full border border-gray-200 bg-white shadow-sm group-hover:scale-110 transition-transform"></div>
                            <span class="text-sm font-medium text-craft-text">简约白 (Standard)</span>
                        </button>
                        <button onclick="setPaper('warm')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-gray-200 hover:border-craft-black hover:bg-gray-50 transition-all text-left group">
                            <div class="w-8 h-8 rounded-full border border-gray-200 bg-[#fefce8] shadow-sm group-hover:scale-110 transition-transform"></div>
                            <span class="text-sm font-medium text-craft-text">护眼黄 (Warm)</span>
                        </button>
                        <button onclick="setPaper('dark_yellow')" class="w-full flex items-center gap-3 p-3 rounded-xl border border-gray-200 hover:border-craft-black hover:bg-gray-50 transition-all text-left group">
                            <div class="w-8 h-8 rounded-full border border-gray-600 bg-[#171717] flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform"><div class="w-3 h-3 rounded-full bg-craft-yellow"></div></div>
                            <span class="text-sm font-medium text-craft-text">黑金流 (MarkCraft)</span>
                        </button>
                    </div>
                </div>

                <!-- AI Config Section (Auto Only) -->
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 block">自动模式 API 配置</label>
                    <div class="p-4 bg-gray-50 rounded-2xl border border-gray-100 space-y-3">
                        <select id="api-provider" class="w-full p-2 rounded-lg border border-gray-200 bg-white text-xs font-mono outline-none shadow-sm focus:border-craft-black transition-colors" onchange="updateAiProvider()">
                            <option value="gemini">Google Gemini</option>
                            <option value="siliconflow" selected>SiliconFlow (Free)</option>
                            <option value="openai">Custom OpenAI</option>
                        </select>
                        <input id="api-key" type="password" class="w-full p-2 rounded-lg border border-gray-200 bg-white text-xs font-mono outline-none shadow-sm focus:border-craft-black transition-colors" placeholder="API Key">
                        <div id="openai-settings" class="hidden space-y-3 pt-2 border-t border-gray-200">
                             <input id="base-url" class="w-full p-2 rounded-lg bg-white text-xs font-mono shadow-sm border border-gray-200" placeholder="Base URL">
                             <input id="model-name" class="w-full p-2 rounded-lg bg-white text-xs font-mono shadow-sm border border-gray-200" placeholder="Model Name">
                        </div>
                    </div>
                </div>

                <div class="text-center pt-4 border-t border-gray-100">
                    <p class="text-[10px] text-gray-300 font-mono">MarkCraft v4.2 • Efficiency Series</p>
                </div>
            </div>
        </div>
    </dialog>

    <!-- PDF Modal -->
    <dialog id="pdfModal" class="m-auto">
        <div class="w-full max-w-sm bg-white rounded-[32px] shadow-2xl p-6 animate-scale-in">
            <h3 class="text-lg font-bold text-craft-black mb-4">导出文件</h3>
            <div class="space-y-3">
                <button onclick="processPdfDirect()" class="w-full p-4 rounded-2xl border border-gray-100 flex items-center gap-3 hover:bg-gray-50"><i data-lucide="download" class="w-5 h-5 text-gray-500"></i> <div class="text-left"><div class="text-sm font-bold">PDF 下载</div><div class="text-xs text-gray-400">生成高清 A4 PDF</div></div></button>
                <button onclick="processPdfPrint()" class="w-full p-4 rounded-2xl border border-gray-100 flex items-center gap-3 hover:bg-gray-50"><i data-lucide="printer" class="w-5 h-5 text-gray-500"></i> <div class="text-left"><div class="text-sm font-bold">系统打印</div><div class="text-xs text-gray-400">调用打印机</div></div></button>
                <button onclick="closeModal('pdfModal')" class="w-full py-3 text-xs font-bold text-gray-400 hover:text-black">取消</button>
            </div>
        </div>
    </dialog>

    <script>
        const apiKey = ""; 
        const DEFAULT_SILICONFLOW_KEY = "sk-kappmrnbawlgggxoaqnpiaaczwhmaqyzmpslslygfzzfsxxv";
        lucide.createIcons();

        // 1. Markdown Config
        const md = window.markdownit({ html: true, breaks: true, linkify: true, typographer: true })
            .use(window.texmath, { engine: window.katex, delimiters: 'dollars', katexOptions: { macros: { "\\RR": "\\mathbb{R}" } } });
        
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const appContainer = document.getElementById('app-container');
        const aiFeedback = document.getElementById('aiFeedback');
        
        let currentDownloadUrl = null;
        let currentDownloadName = '';
        let currentPaper = 'white';
        const paperStyles = { white: {bg:'#ffffff',text:'#1d1d1f',name:'简约白'}, warm: {bg:'#fefce8',text:'#422006',name:'护眼黄'}, dark_yellow: {bg:'#171717',text:'#facc15',name:'黑金流'} };

        // --- Core Editor Logic ---
        function applyPreviewTheme() {
            const s = paperStyles[currentPaper];
            const isDark = currentPaper.includes('dark');
            const codeBlocks = preview.querySelectorAll('pre');
            codeBlocks.forEach(b => {
                b.style.background = isDark ? '#262626' : '#f9fafb';
                b.style.color = isDark ? '#eee' : '#1d1d1f';
                b.style.borderColor = isDark ? '#404040' : 'rgba(0,0,0,0.05)';
            });
            const titles = preview.querySelectorAll('h1, h2, h3');
            titles.forEach(t => t.style.color = isDark ? '#facc15' : 'inherit');
        }

        function syncEditor() {
            try {
                let rawContent = editor.value.replace(/\\\[([\s\S]*?)\\\]/g, '$$$$$1$$$$').replace(/\\\(([\s\S]*?)\\\)/g, '$$$1$$');
                let raw = md.render(rawContent);
                preview.innerHTML = DOMPurify.sanitize(raw, { ADD_TAGS: ['math','annotation','semantics','mn','mo','mi','msup','msub','mfrac','mroot','msqrt','mtable','mtr','mtd','mlabeledtr','mrow','span','svg','path'], ADD_ATTR: ['class','style','aria-hidden','xmlns','viewBox','d','fill','height','width'] });
                preview.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                applyPreviewTheme(); 
            } catch(e) { console.error(e); }
        }

        // Insert Syntax with Scroll Restoration
        function insertSyntax(prefix, suffix) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selection = text.substring(start, end);
            const scrollTop = editor.scrollTop; 
            let before = text.substring(0, start);
            let after = text.substring(end);
            if (prefix.trim().startsWith('#') && before.length > 0 && !before.endsWith('\n')) { before += '\n'; }
            const newText = before + prefix + selection + suffix + after;
            editor.value = newText;
            editor.scrollTop = scrollTop;
            editor.focus();
            const newCursorPos = start + prefix.length + selection.length + (selection ? suffix.length : 0);
            if (!selection) editor.setSelectionRange(start + prefix.length, start + prefix.length); else editor.setSelectionRange(newCursorPos, newCursorPos);
            editor.scrollTop = scrollTop; 
            syncEditor();
        }

        // Modified Clear Formatting
        function clearFormatting() {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            if (start === end) return; 
            const scrollTop = editor.scrollTop;
            let selection = text.substring(start, end);
            const wrappers = ['**', '*', '`', '$$', '==', '~~'];
            for (let w of wrappers) {
                while (selection.startsWith(w) && selection.endsWith(w) && selection.length >= w.length * 2) {
                    selection = selection.substring(w.length, selection.length - w.length);
                }
            }
            selection = selection.replace(/^#+\s*/gm, '').replace(/^>\s*/gm, '').replace(/^-\s*/gm, '');
            const newText = text.substring(0, start) + selection + text.substring(end);
            editor.value = newText;
            editor.scrollTop = scrollTop;
            editor.focus();
            editor.setSelectionRange(start, start + selection.length);
            syncEditor();
            showToast("格式已清除");
        }
        
        function insertMathFormula() { insertSyntax('$$', '$$'); }
        function insertCodeBlock() { insertSyntax('```\n', '\n```'); }

        const contextMenu = document.getElementById('context-menu');
        const ctxAiBtn = document.getElementById('ctx-ai-btn');

        editor.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const hasSelection = editor.selectionStart !== editor.selectionEnd;
            if (hasSelection) { ctxAiBtn.classList.remove('disabled'); ctxAiBtn.innerHTML = '<i data-lucide="wand-2"></i> AI 润色选中'; } else { ctxAiBtn.classList.add('disabled'); ctxAiBtn.innerHTML = '<i data-lucide="wand-2"></i> 请先选中文字'; }
            lucide.createIcons();
            const x = e.clientX; const y = e.clientY;
            const menuWidth = 160; const menuHeight = 200;
            const finalX = (x + menuWidth > window.innerWidth) ? x - menuWidth : x;
            const finalY = (y + menuHeight > window.innerHeight) ? y - menuHeight : y;
            contextMenu.style.left = `${finalX}px`; contextMenu.style.top = `${finalY}px`; contextMenu.style.display = 'block';
        });
        document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

        function switchMobileTab(tab) {
            const editBtn = document.getElementById('tab-edit'); const viewBtn = document.getElementById('tab-view');
            const paneEdit = document.getElementById('pane-edit'); const paneView = document.getElementById('pane-view');
            if (tab === 'edit') {
                editBtn.classList.add('bg-white', 'text-black', 'shadow-sm'); editBtn.classList.remove('text-gray-500');
                viewBtn.classList.remove('bg-white', 'text-black', 'shadow-sm'); viewBtn.classList.add('text-gray-500');
                paneEdit.classList.remove('hidden-on-mobile'); paneView.classList.add('hidden-on-mobile');
            } else {
                viewBtn.classList.add('bg-white', 'text-black', 'shadow-sm'); viewBtn.classList.remove('text-gray-500');
                editBtn.classList.remove('bg-white', 'text-black', 'shadow-sm'); editBtn.classList.add('text-gray-500');
                paneView.classList.remove('hidden-on-mobile'); paneEdit.classList.add('hidden-on-mobile');
                syncEditor();
            }
        }
        
        function enterApp() {
            const overlay = document.getElementById('guide-overlay');
            if(overlay) { overlay.classList.add('opacity-0', 'pointer-events-none'); appContainer.classList.remove('blur-active'); setTimeout(() => overlay.remove(), 500); }
        }
        
        function openSettingsModal() { updateAiProvider(); document.getElementById('settingsModal').showModal(); }
        function closeModal(id) { 
            const modal = document.getElementById(id);
            if (modal) modal.close(); 
        }
        
        function setPaper(style) {
            currentPaper = style; const s = paperStyles[style]; const isDark = style.includes('dark');
            document.getElementById('editor').style.color = s.text; document.getElementById('editor').parentElement.style.backgroundColor = isDark ? '#171717' : '#ffffff';
            preview.style.backgroundColor = s.bg; preview.style.color = s.text; applyPreviewTheme(); closeModal('settingsModal'); showToast(`已切换: ${s.name}`);
        }
        
        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

        function showAiFeedback() { aiFeedback.classList.add('show'); setTimeout(() => { if(aiFeedback.classList.contains('show')) closeAiFeedback(); }, 10000); }
        function closeAiFeedback() { aiFeedback.classList.remove('show'); }
        
        editor.addEventListener('input', syncEditor);

        function exportWord() {
            showToast("正在处理 Word 格式...");
            let htmlContent = preview.innerHTML;
            const wordHTML = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset="utf-8"><title>Export</title><style>body{font-family:'SimSun','宋体',serif;line-height:1.5;font-size:12pt}h1{font-family:'SimHei','黑体',sans-serif;font-size:22pt;font-weight:bold}h2{font-family:'SimHei','黑体',sans-serif;font-size:16pt;font-weight:bold;margin-top:20px}h3{font-family:'SimHei','黑体',sans-serif;font-size:14pt;font-weight:bold}p{margin-bottom:10px;text-align:justify}table{border-collapse:collapse;width:100%;border:1px solid #000}td,th{border:1px solid #000;padding:5px}code{font-family:'Courier New',monospace;background:#eee}.katex{font-size:11pt}</style></head><body>${htmlContent}</body></html>`;
            const blob = new Blob(['\ufeff', wordHTML], { type: 'application/msword' });
            showExportResult('word', URL.createObjectURL(blob), `MarkCraft_${Date.now()}.doc`);
        }

        function openPdfOptions() { document.getElementById('pdfModal').showModal(); }
        function showExportResult(type, url, filename) {
            currentDownloadUrl = url; currentDownloadName = filename;
            const overlay = document.getElementById('exportResultOverlay'); const card = document.getElementById('exportResult');
            const icon = document.getElementById('exportIcon'); const nameEl = document.getElementById('exportFilename');
            overlay.classList.remove('hidden', 'opacity-0', 'pointer-events-none'); nameEl.innerText = filename;
            if (type === 'word') icon.setAttribute('data-lucide', 'file-type-2'); else if (type === 'pdf') icon.setAttribute('data-lucide', 'file-text'); else icon.setAttribute('data-lucide', 'image');
            lucide.createIcons();
            setTimeout(() => { card.classList.remove('scale-95', 'opacity-0'); card.classList.add('scale-100', 'opacity-100'); }, 100);
        }
        function closeExportResult(e) { if(e) e.stopPropagation(); const overlay = document.getElementById('exportResultOverlay'); const card = document.getElementById('exportResult'); card.classList.remove('scale-100', 'opacity-100'); card.classList.add('scale-95', 'opacity-0'); setTimeout(() => { overlay.classList.add('hidden', 'opacity-0', 'pointer-events-none'); }, 300); }
        function triggerDownload() { if (!currentDownloadUrl) return; const link = document.createElement('a'); link.href = currentDownloadUrl; link.download = currentDownloadName; document.body.appendChild(link); link.click(); document.body.removeChild(link); triggerConfetti(); closeExportResult(); }
        function processPdfDirect() { closeModal('pdfModal'); showToast("正在生成 PDF..."); const opt = { margin: 10, filename: `Doc_${Date.now()}.pdf`, image: {type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} }; html2pdf().set(opt).from(preview).save(); }
        function processPdfPrint() { closeModal('pdfModal'); document.getElementById('print-area').innerHTML = preview.innerHTML; window.print(); }
        function exportImage() { showToast("正在生成长图..."); const originalStyle = preview.getAttribute('style'); preview.style.height = 'auto'; preview.style.overflow = 'visible'; preview.style.boxShadow = 'none'; html2canvas(preview, { scale: 2, useCORS: true }).then(canvas => { const url = canvas.toDataURL('image/png'); showExportResult('image', url, 'MarkCraft_Snapshot.png'); }).finally(() => { preview.setAttribute('style', originalStyle || ''); setPaper(currentPaper); }); }
        function downloadMarkdown() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([editor.value],{type:'text/markdown'})); a.download='doc.md'; a.click(); }

        // --- Manual Guide Logic (Updated Prompt) ---
        function openManualGuide() { document.getElementById('manualGuideModal').showModal(); }
        function copyManualPrompt() {
            // New stricter manual prompt
            const prompt = `你是一个专业的 Markdown 修复工具。请帮我修复这段文本的格式错误（特别是数学公式和排版），但**绝对不要修改原文的内容和措辞**。

请严格遵循以下要求：
1. **内容不变**：只修格式，不改文字。
2. **公式修复**：将乱码的数学公式转换为标准的 LaTeX 格式（包裹在 $ 或 $$ 中）。
3. **输出纯 Markdown**：直接输出修复后的 Markdown 源码，方便我复制。
4. **不要闲聊**：不要说“好的”、“修复如下”等，直接给我代码。

请处理以下文本：\n\n${editor.value}`;
            navigator.clipboard.writeText(prompt).then(() => showToast("提示词已复制，请去元宝粘贴")).catch(() => showToast("复制失败，请手动复制"));
        }
        
        function updateAiProvider() {
            const provider = document.getElementById('api-provider').value;
            const openai = document.getElementById('openai-settings');
            const keyInput = document.getElementById('api-key');
            if (provider === 'siliconflow') { 
                openai.classList.remove('hidden'); 
                document.getElementById('base-url').value = "https://api.siliconflow.cn/v1"; 
                document.getElementById('model-name').value = "Qwen/Qwen2-7B-Instruct"; 
                if(!keyInput.value) keyInput.value = DEFAULT_SILICONFLOW_KEY; 
            } 
            else if (provider === 'openai') { 
                openai.classList.remove('hidden'); 
                document.getElementById('base-url').value = ""; 
                document.getElementById('model-name').value = ""; 
                keyInput.placeholder = "sk-..."; 
                if(keyInput.value === DEFAULT_SILICONFLOW_KEY) keyInput.value = ""; 
            } 
            else { 
                openai.classList.add('hidden'); 
                keyInput.placeholder = "默认使用 (Gemini)"; 
                keyInput.value = ""; 
            }
        }
        
        // --- Updated AI Beautify Logic ---
        async function aiBeautify() {
            const start = editor.selectionStart; const end = editor.selectionEnd; const hasSelection = start !== end; const selectedText = editor.value.substring(start, end);
            const textToProcess = hasSelection ? selectedText : editor.value;
            if(!textToProcess.trim()) { showToast("请先输入或选中内容"); return; }
            showToast("AI 修复中... (格式优化)"); 
            const providerEl = document.getElementById('api-provider'); if(!providerEl.value) updateAiProvider();
            const provider = providerEl.value; const userKey = document.getElementById('api-key').value.trim();
            
            // STRICT System Prompt
            const systemPrompt = `You are a strict Markdown syntax corrector. Your ONLY job is to fix Markdown formatting errors and broken LaTeX math formulas. 
Rules:
1. **DO NOT change the original meaning, wording, or content.** Keep the text exactly as is, only fixing syntax.
2. Fix broken LaTeX math (e.g., convert "a^2 + b^2 = c^2" to "$a^2 + b^2 = c^2$").
3. Ensure headings, lists, and bold text use correct Markdown syntax.
4. Output ONLY the raw Markdown content. Do not output conversational text.`;

            try {
                let resText = "";
                // Fixed URL format here
                const baseUrl = "https://api.siliconflow.cn/v1"; 
                const model = "Qwen/Qwen2-7B-Instruct";
                const res = await fetch(`${baseUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userKey}` }, body: JSON.stringify({ model, messages: [{role:"system",content:systemPrompt},{role:"user",content:textToProcess}], temperature: 0.1 }) });
                const d = await res.json(); resText = d.choices?.[0]?.message?.content;
                
                if (resText) {
                    const cleanText = resText.replace(/^```markdown\n/,'').replace(/\n```$/,'');
                    if (hasSelection) editor.value = editor.value.substring(0, start) + cleanText + editor.value.substring(end); else editor.value = cleanText;
                    syncEditor(); showToast("格式修复完成"); triggerConfetti(); showAiFeedback();
                } else throw new Error("无返回");
            } catch(e) { showToast("API 错误: " + e.message); }
        }
        
        function triggerConfetti() { if(typeof confetti === 'function') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#facc15', '#171717', '#ffffff'] }); }
        function aiBeautifySelection() { aiBeautify(); }
        function openAIModal() { aiBeautify(); } 

        // Init
        editor.value = `# MarkCraft v4.2\n\n欢迎使用 **MarkCraft**，您的高效排版助手。\n\n## 📝 功能更新\n1. **AI 润色升级**：内部 AI 现已锁定为“无损模式”，仅修复格式和公式，不改动您的文字。\n2. **手动模式优化**：增加了醒目的提示，确保您从 AI 复制的是正确的 Markdown 源码。\n\n## 🔧 试一试\n选中下方混乱的公式，右键点击“AI 润色选中”：\n\nE=mc2 和 a2+b2=c2\n\n## 💡 提示\n若遇到极其复杂的公式，请点击右上角的 **设置** -> **启用手动模式**，使用腾讯元宝等强力模型。`;
        setPaper('white'); syncEditor(); updateAiProvider();
    </script>

    <script src="pwa.js"></script>
</body>
</html>
