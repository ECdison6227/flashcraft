<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>LifeCraft - 智能生活工坊</title>

  <!-- PWA Settings -->
  <meta name="theme-color" content="#171717" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  
  <!-- Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- Mobile Drag Polyfill (Critical for Touch Devices) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
  <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
  <script>
    // Initialize Drag Polyfill
    var MobileDragDrop = MobileDragDrop || {};
    MobileDragDrop.polyfill({
        // Force drag image to be visible
        dragImageTranslateOverride: MobileDragDrop.scrollBehaviourDragImageTranslateOverride,
        // Hold to drag delay (ms) - prevents accidental drags while scrolling
        holdToDrag: 200 
    });
  </script>

  <!-- Configuration -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            craft: {
              black: '#171717',
              gray: '#f5f5f7',
              white: '#ffffff',
              yellow: '#facc15', 
              blue: '#3b82f6',
              red: '#ef4444',
              border: '#e5e5e5',
              text: '#1d1d1f'
            }
          },
          animation: {
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            'fade-in': 'fadeIn 0.2s ease-out forwards',
            'pulse-slow': 'pulseSlow 3s infinite',
            'progress-stripes': 'progressStripes 1s linear infinite',
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
            fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
            pulseSlow: { '0%, 100%': { opacity: 1 }, '50%': { opacity: 0.8 } },
            progressStripes: { '0%': { backgroundPosition: '1rem 0' }, '100%': { backgroundPosition: '0 0' } }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
    
    body { background-color: #f5f5f7; color: #1d1d1f; overflow: hidden; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; user-select: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    /* CRITICAL FIX FOR MOBILE DRAG */
    .draggable-source { 
        cursor: grab; 
        touch-action: none; /* Disables browser scrolling on this element */
        -webkit-user-select: none;
        user-select: none;
    }
    .draggable-source:active { cursor: grabbing; opacity: 0.5; transform: scale(0.95); }
    
    /* Drop Zone Highlight */
    .drag-over { 
        background-color: rgba(250, 204, 21, 0.15) !important; 
        border-color: #facc15 !important; 
        box-shadow: inset 0 0 0 2px #facc15;
    }

    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #171717; cursor: pointer; margin-top: -6px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e5e5; border-radius: 2px; }

    .striped-bar {
        background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
        background-size: 1rem 1rem;
    }
  </style>
</head>
<body>
  <a
    href="index.html"
    class="fixed z-[9999] flex items-center gap-2 px-3 py-2 rounded-full bg-black/60 text-white backdrop-blur-md border border-white/10 shadow-lg hover:bg-black/70 active:scale-95 transition"
    style="left: calc(env(safe-area-inset-left) + 16px); bottom: calc(env(safe-area-inset-bottom) + 16px);"
    aria-label="返回 Craft Family 主页"
  >
    <span class="text-sm leading-none">⌂</span>
    <span class="text-xs font-bold">返回主页</span>
  </a>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo } = React;

    // --- Supabase Config ---
    const SUPABASE_URL = 'https://jkhboywafpdesmdguvts.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpraGJveXdhZnBkZXNtZGd1dnRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNTYyMjYsImV4cCI6MjA4MTYzMjIyNn0.eT1-D9nsBNaWw6jHmpGjF6dGK_EUSnCTjAp3IZlZNx0';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    /* DB Schema Requirement (Supabase):
       Table: tasks
       Columns: id (text), user_id (uuid), title (text), status (text), day (text), type (text), kind (text), share_code (text), participants (jsonb), completed (bool), completed_dates (jsonb), linked_deck (bool), price (text), created_at (timestamp)
    */

    // --- Constants ---
    const FLASHCRAFT_URL = "https://ecdison6227.github.io/flashcraft/";
    const generateId = () => 'task_' + Date.now() + Math.random().toString(36).substr(2, 5);
    const generateShareCode = () => 'LC-' + Math.random().toString(36).substr(2, 4).toUpperCase();
    const WEEK_DAYS = [
      { key: 'Mon', label: '周一' }, { key: 'Tue', label: '周二' }, { key: 'Wed', label: '周三' },
      { key: 'Thu', label: '周四' }, { key: 'Fri', label: '周五' }, { key: 'Sat', label: '周六' }, { key: 'Sun', label: '周日' }
    ];
    const TASKS_TABLE = 'tasks';
    const STORAGE_TASKS_KEY = 'lc_tasks_v7';
    const STORAGE_MODE_KEY = 'lc_mode';

    const asJsonArray = (value, fallback = []) => {
      if (Array.isArray(value)) return value;
      if (typeof value === 'string') {
        try {
          const parsed = JSON.parse(value);
          return Array.isArray(parsed) ? parsed : fallback;
        } catch (_) {
          return fallback;
        }
      }
      return fallback;
    };

    const toIsoString = (value) => {
      if (!value) return new Date().toISOString();
      if (typeof value === 'string') {
        const ms = Date.parse(value);
        if (!Number.isNaN(ms)) return new Date(ms).toISOString();
        return new Date().toISOString();
      }
      if (typeof value === 'number') return new Date(value).toISOString();
      if (value instanceof Date) return value.toISOString();
      return new Date().toISOString();
    };

    const rowToTask = (row) => {
      const createdMs = row?.created_at ? Date.parse(row.created_at) : NaN;
      return {
        id: row?.id,
        title: row?.title || '',
        status: row?.status || 'inbox',
        mode: row?.mode || 'life',
        day: row?.day ?? null,
        startTime: row?.start_time || row?.startTime || '09:00',
        duration: Number.isFinite(row?.duration) ? row.duration : 25,
        linkedDeck: !!(row?.linked_deck ?? row?.linkedDeck),
        price: row?.price || '',
        completed: !!row?.completed,
        completed_dates: asJsonArray(row?.completed_dates, []),
        type: row?.type || 'one-off',
        kind: row?.kind || 'single',
        owner_id: row?.user_id || row?.owner_id || null,
        share_code: row?.share_code || null,
        participants: asJsonArray(row?.participants, []),
        created_at: Number.isNaN(createdMs) ? Date.now() : createdMs
      };
    };

    const buildTaskRow = (task) => ({
      id: task?.id,
      user_id: task?.owner_id,
      title: task?.title || '',
      status: task?.status || 'inbox',
      day: task?.day ?? null,
      type: task?.type || 'one-off',
      kind: task?.kind || 'single',
      share_code: task?.share_code || null,
      participants: Array.isArray(task?.participants) ? task.participants : [],
      completed: !!task?.completed,
      completed_dates: Array.isArray(task?.completed_dates) ? task.completed_dates : [],
      linked_deck: !!task?.linkedDeck,
      price: task?.price || '',
      created_at: toIsoString(task?.created_at),
      // Optional extended fields (if you add columns in Supabase)
      mode: task?.mode || null,
      start_time: task?.startTime || null,
      duration: Number.isFinite(task?.duration) ? task.duration : null
    });

    const stripExtendedColumns = (row) => {
      const { mode, start_time, duration, ...rest } = row || {};
      return rest;
    };

    // --- Components ---
    const Icon = ({ name, size = 20, className = "", onClick }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current) {
            ref.current.innerHTML = '';
            const i = document.createElement('i');
            i.setAttribute('data-lucide', name);
            i.setAttribute('width', size);
            i.setAttribute('height', size);
            if (className) i.setAttribute('class', className);
            ref.current.appendChild(i);
            lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' });
        }
      }, [name, size, className]);
      return <span ref={ref} onClick={onClick} className={`inline-flex items-center justify-center ${className}`}></span>;
    };

    const CraftLogo = () => (
      <div className="w-8 h-8 bg-craft-black text-white rounded-lg flex items-center justify-center shadow-sm">
        <svg width="18" height="18" viewBox="0 0 100 100" fill="none">
           <path d="M25 20V80H75V65H40V20H25Z" fill="currentColor"/>
        </svg>
      </div>
    );

    // --- Views ---

    const LoginView = ({ onLoginSuccess }) => {
        const [email, setEmail] = useState('');
        const [isSending, setIsSending] = useState(false);
        const [sent, setSent] = useState(false);
        const [code, setCode] = useState('');

        const handleSend = async () => {
            if (!email) return;
            setIsSending(true);
            const { error } = await supabase.auth.signInWithOtp({ email, options: { shouldCreateUser: true }});
            setIsSending(false);
            if (!error) setSent(true);
            else alert(error.message);
        };

        const handleVerify = async () => {
            const { data, error } = await supabase.auth.verifyOtp({ email, token: code, type: 'email' });
            if (!error && data.session) onLoginSuccess(data.session);
            else alert(error?.message || "验证失败");
        };

        return (
            <div className="fixed inset-0 z-[300] bg-white flex flex-col items-center justify-center p-6 animate-fade-in">
                <div className="w-20 h-20 bg-craft-black rounded-3xl flex items-center justify-center shadow-2xl mb-8 transform -rotate-3">
                    <CraftLogo />
                </div>
                <h2 className="text-2xl font-black text-craft-black mb-2">LifeCraft</h2>
                <p className="text-sm text-gray-500 mb-8 text-center max-w-xs">登录以启用多人协作、数据同步与任务云端存储。</p>
                
                {!sent ? (
                    <div className="w-full max-w-sm space-y-4">
                        <input value={email} onChange={e => setEmail(e.target.value)} placeholder="name@example.com" className="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:border-black outline-none font-medium transition-all"/>
                        <button onClick={handleSend} disabled={isSending} className="w-full py-4 bg-craft-black text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all">
                            {isSending ? '发送中...' : '获取验证码'}
                        </button>
                        <button onClick={() => onLoginSuccess(null)} className="w-full py-2 text-xs font-bold text-gray-400 hover:text-black">暂不登录 (本地模式)</button>
                    </div>
                ) : (
                    <div className="w-full max-w-sm space-y-4 animate-slide-up">
                        <div className="p-3 bg-green-50 text-green-700 text-xs font-bold rounded-xl text-center">验证码已发送至 {email}</div>
                        <input value={code} onChange={e => setCode(e.target.value)} placeholder="输入 6 位验证码" className="w-full p-4 bg-gray-50 rounded-2xl border border-gray-100 focus:border-black outline-none font-medium text-center tracking-widest text-lg transition-all"/>
                        <button onClick={handleVerify} className="w-full py-4 bg-craft-black text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all">验证登录</button>
                    </div>
                )}
            </div>
        );
    };

    const FocusView = ({ task, onClose, onComplete }) => {
        const [duration, setDuration] = useState(task.duration || 25);
        const [elapsed, setElapsed] = useState(0);
        const [isActive, setIsActive] = useState(false);
        const totalSeconds = duration * 60;

        useEffect(() => {
          let interval = null;
          if (isActive && elapsed < totalSeconds) {
            interval = setInterval(() => setElapsed(t => t + 1), 1000);
          } else if (elapsed >= totalSeconds && isActive) {
            setIsActive(false);
            onComplete();
          }
          return () => clearInterval(interval);
        }, [isActive, elapsed]);

        const formatTime = (s) => {
          const left = Math.max(0, totalSeconds - s);
          return `${String(Math.floor(left / 60)).padStart(2,'0')}:${String(left % 60).padStart(2,'0')}`;
        };

        const progress = elapsed / totalSeconds;
        const radius = 120;
        const circumference = 2 * Math.PI * radius;
        const strokeDashoffset = circumference - progress * circumference;

        return (
          <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center animate-fade-in bg-white">
             <div className="absolute top-0 w-full p-6 safe-top flex justify-between items-center">
                <div className="flex items-center gap-2">
                    <div className={`w-2 h-2 bg-black rounded-full ${isActive ? 'animate-pulse' : ''}`}></div>
                    <span className="text-xs font-mono font-bold tracking-widest uppercase">Focus Mode</span>
                </div>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors"><Icon name="x" size={24} className="text-black"/></button>
             </div>
             <div className="relative z-10 flex flex-col items-center gap-12 w-full max-w-sm px-6">
                <div className="text-center space-y-2">
                    <h2 className="text-3xl font-black text-black tracking-tight">{task.title}</h2>
                </div>
                <div className="relative w-72 h-72 flex items-center justify-center">
                    <svg className="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 300 300">
                        <circle cx="150" cy="150" r="120" stroke="#f5f5f7" strokeWidth="8" fill="none" />
                        <circle cx="150" cy="150" r="120" stroke="#171717" strokeWidth="8" fill="none" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round" className="transition-all duration-1000 ease-linear"/>
                    </svg>
                    <div className="text-center z-10">
                        <div className="text-7xl font-mono font-bold tracking-tighter tabular-nums text-black">{formatTime(elapsed)}</div>
                    </div>
                </div>
                <div className="w-full space-y-8">
                    {!isActive && (
                        <div className="space-y-4 px-4">
                            <div className="flex justify-between items-center text-xs font-bold uppercase tracking-wider text-gray-400"><span>Duration</span><span className="text-black">{duration} min</span></div>
                            <input type="range" min="5" max="120" step="5" value={duration} onChange={(e) => setDuration(Number(e.target.value))} className="w-full" />
                        </div>
                    )}
                    <div className="flex justify-center gap-6">
                        <button onClick={() => setIsActive(!isActive)} className="w-20 h-20 rounded-full bg-black text-white flex items-center justify-center shadow-2xl active:scale-95 transition-transform hover:bg-gray-900"><Icon name={isActive ? "pause" : "play"} size={32} fill="currentColor"/></button>
                    </div>
                </div>
             </div>
          </div>
        );
    };

    // --- Main App Logic ---
    function App() {
        // --- State ---
        const [session, setSession] = useState(null);
        const [user, setUser] = useState(null);
        const [showLogin, setShowLogin] = useState(false);

        const [mode, setMode] = useState(() => localStorage.getItem(STORAGE_MODE_KEY) || 'life');
        const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
        const [isInboxOpen, setIsInboxOpen] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [isJoinModalOpen, setIsJoinModalOpen] = useState(false);
        const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
        const [toast, setToast] = useState(null);
        
        const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem(STORAGE_TASKS_KEY) || '[]'));
        const [activeDay, setActiveDay] = useState('Mon');
        const [dragOverDay, setDragOverDay] = useState(null);
        
        const [formData, setFormData] = useState({});
        const [focusTask, setFocusTask] = useState(null);
        const [editingTask, setEditingTask] = useState(null); 
        const [detailTask, setDetailTask] = useState(null); 
        const [joinCode, setJoinCode] = useState('');
        const cloudCapsRef = useRef({ extendedColumns: true });
        const cloudLoadedUserIdRef = useRef(null);

        // Init & Auth Check
        useEffect(() => {
            const init = async () => {
                setIsMobile(window.innerWidth < 768);
                const d = new Date().getDay();
                const dayMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                setActiveDay(dayMap[d]);
                if (window.innerWidth >= 768) setIsInboxOpen(true);

                // Handle invite link (?join=LC-XXXX)
                try {
                    const params = new URLSearchParams(window.location.search);
                    const code = params.get('join');
                    if (code) {
                        setJoinCode(code.trim().toUpperCase());
                        setIsJoinModalOpen(true);
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (_) {}

                // Auth
                const { data } = await supabase.auth.getSession();
                setSession(data.session);
                setUser(data.session?.user || null);
                if (!data.session) setShowLogin(true);
                else loadCloudTasks(data.session.user.id);
            };
            window.addEventListener('resize', () => setIsMobile(window.innerWidth < 768));
            init();
        }, []);

        useEffect(() => {
            if (user?.id && cloudLoadedUserIdRef.current !== user.id) loadCloudTasks(user.id);
        }, [user?.id]);

        useEffect(() => {
            localStorage.setItem(STORAGE_TASKS_KEY, JSON.stringify(tasks));
            localStorage.setItem(STORAGE_MODE_KEY, mode);
        }, [tasks, mode]);

        // Handlers
        const showToast = (msg, type='success') => {
            setToast({ msg, type });
            setTimeout(() => setToast(null), 2000);
        };

        const normalizeTaskForCloud = (task) => {
            if (!user?.id) return task;
            const ownerId = task?.owner_id && task.owner_id !== 'local_user' ? task.owner_id : user.id;
            const participants = Array.isArray(task?.participants) ? task.participants : [];
            const hasOwner = participants.some(p => p?.uid === ownerId);
            const nextParticipants = hasOwner ? participants : [{ uid: ownerId, email: user?.email || 'Me', status: 'pending' }, ...participants];
            return { ...task, owner_id: ownerId, participants: nextParticipants };
        };

        const upsertTaskCloud = async (task) => {
            if (!user?.id) return { ok: false, kind: 'no_user' };
            const normalized = normalizeTaskForCloud(task);
            const fullRow = buildTaskRow(normalized);
            const primaryRow = cloudCapsRef.current.extendedColumns ? fullRow : stripExtendedColumns(fullRow);

            let res = await supabase.from(TASKS_TABLE).upsert(primaryRow, { onConflict: 'id' });
            if (res.error && cloudCapsRef.current.extendedColumns && /column .* does not exist/i.test(res.error.message || '')) {
                cloudCapsRef.current.extendedColumns = false;
                res = await supabase.from(TASKS_TABLE).upsert(stripExtendedColumns(fullRow), { onConflict: 'id' });
            }
            if (res.error) {
                console.error('Supabase upsert task error:', res.error);
                showToast(`云端同步失败：${res.error.message}`, 'error');
                return { ok: false, kind: 'error', error: res.error };
            }
            return { ok: true, kind: 'ok' };
        };

        const deleteTaskCloud = async (taskId) => {
            if (!user?.id) return { ok: false, kind: 'no_user' };
            const { error } = await supabase.from(TASKS_TABLE).delete().eq('id', taskId);
            if (error) {
                console.error('Supabase delete task error:', error);
                showToast(`云端删除失败：${error.message}`, 'error');
                return { ok: false, kind: 'error', error };
            }
            return { ok: true, kind: 'ok' };
        };

        const loadCloudTasks = async (uid) => {
            if (!uid) return;
            try {
                const ownedRes = await supabase.from(TASKS_TABLE).select('*').eq('user_id', uid).order('created_at', { ascending: false });
                if (ownedRes.error) throw ownedRes.error;

                const map = new Map((ownedRes.data || []).map(r => [r.id, r]));
                // Best-effort: also load tasks where I'm a participant (requires RLS + jsonb contains)
                const partRes = await supabase.from(TASKS_TABLE).select('*').contains('participants', [{ uid }]).order('created_at', { ascending: false });
                if (!partRes.error) (partRes.data || []).forEach(r => map.set(r.id, r));

                const cloudTasks = Array.from(map.values()).map(rowToTask);
                if (cloudTasks.length) setTasks(cloudTasks);
                else if (tasks.length) showToast('云端暂无任务，已保留本地任务', 'success');
                cloudLoadedUserIdRef.current = uid;
            } catch (e) {
                console.error('Load cloud tasks error:', e);
                showToast(`加载云端失败：${e?.message || String(e)}`, 'error');
            }
        };

        const handleLoginSuccess = (sessionData) => {
            setSession(sessionData);
            setUser(sessionData?.user || null);
            setShowLogin(false);
            if (sessionData?.user?.id) {
                showToast("登录成功");
                loadCloudTasks(sessionData.user.id);
            }
        };

        const handleSignOut = async () => {
            await supabase.auth.signOut();
            setSession(null);
            setUser(null);
            cloudLoadedUserIdRef.current = null;
            setShowLogin(true);
        };

        const saveTask = (e) => {
            e.preventDefault();
            if (!formData.title?.trim()) return;

            const isMulti = formData.kind === 'multi';
            const shareCode = isMulti ? generateShareCode() : null;
            const ownerId = user?.id || 'local_user';

            if (editingTask) {
                const updatedTask = {
                    ...editingTask,
                    title: formData.title,
                    type: formData.type || editingTask.type || 'one-off',
                    kind: formData.kind || editingTask.kind || 'single',
                    status: formData.status || editingTask.status || 'inbox',
                    day: formData.day ?? editingTask.day ?? null,
                    startTime: formData.startTime || editingTask.startTime || '09:00',
                    linkedDeck: formData.linkedDeck == null ? !!editingTask.linkedDeck : !!formData.linkedDeck,
                    price: formData.price ?? editingTask.price ?? ''
                };
                setTasks(prev => prev.map(t => t.id === editingTask.id ? { ...t, ...updatedTask } : t));
                if (user?.id) void upsertTaskCloud(updatedTask);
                showToast("任务已更新");
            } else {
                const newTask = {
                    id: generateId(),
                    title: formData.title,
                    status: 'inbox',
                    mode: mode,
                    day: null,
                    startTime: '09:00',
                    duration: 25,
                    linkedDeck: formData.linkedDeck || false,
                    price: '', 
                    completed: false,
                    completed_dates: [],
                    type: formData.type || 'one-off',
                    kind: formData.kind || 'single',
                    owner_id: ownerId,
                    share_code: shareCode,
                    participants: [{ uid: ownerId, email: user?.email || 'Me', status: 'pending' }],
                    created_at: Date.now()
                };
                setTasks(prev => [newTask, ...prev]);
                if (user?.id) void upsertTaskCloud(newTask);
                showToast(isMulti ? "多人任务已创建" : "任务已添加");
            }
            setIsModalOpen(false);
            setEditingTask(null);
            setFormData({});
        };

        // Logic: Task State Toggle
        const toggleTaskState = (task) => {
            const todayStr = new Date().toDateString();

            setTasks(prev => {
                let updatedTask = null;
                const next = prev.map(t => {
                    if (t.id !== task.id) return t;

                    // 1) Periodic: mark today as done, don't hide
                    if (t.type === 'periodic') {
                        const dates = Array.isArray(t.completed_dates) ? t.completed_dates : [];
                        const isDoneToday = dates.includes(todayStr);
                        const newDates = isDoneToday ? dates.filter(d => d !== todayStr) : [...dates, todayStr];
                        if (!isDoneToday) confetti({ particleCount: 40, spread: 50, origin: { y: 0.7 } });
                        updatedTask = { ...t, completed_dates: newDates };
                        return updatedTask;
                    }

                    // 2) Multiplayer: update MY status, don't hide task
                    if (t.kind === 'multi') {
                        const myId = user?.id || 'local_user';
                        const participants = Array.isArray(t.participants) ? t.participants : [];
                        const newParticipants = participants.map(p =>
                            p.uid === myId ? { ...p, status: p.status === 'done' ? 'pending' : 'done' } : p
                        );
                        const allDone = newParticipants.every(p => p.status === 'done');
                        const amIDone = newParticipants.find(p => p.uid === myId)?.status === 'done';
                        if (amIDone) confetti({ particleCount: 60, spread: 70, origin: { y: 0.7 }, colors: ['#3b82f6', '#fff'] });
                        updatedTask = { ...t, participants: newParticipants, completed: allDone };
                        return updatedTask;
                    }

                    // 3) One-off: standard completion
                    const newVal = !t.completed;
                    if (newVal) confetti({ particleCount: 60, spread: 70, origin: { y: 0.7 }, colors: mode === 'tutor' ? ['#facc15', '#000'] : ['#3b82f6', '#fff'] });
                    updatedTask = { ...t, completed: newVal };
                    return updatedTask;
                });

                if (updatedTask && user?.id) Promise.resolve().then(() => upsertTaskCloud(updatedTask));
                return next;
            });
        };

        const joinTask = async () => {
            const code = joinCode.trim().toUpperCase();
            if (!code) return;

            // Cloud mode: join by share_code
            if (user?.id) {
                const { data, error } = await supabase.from(TASKS_TABLE).select('*').eq('share_code', code).maybeSingle();
                if (error || !data) {
                    showToast("无效的邀请码", "error");
                    return;
                }

                const taskFromCloud = rowToTask(data);
                if (taskFromCloud.kind !== 'multi') {
                    showToast("该邀请码不是多人协作任务", "error");
                    return;
                }

                const myId = user.id;
                const participants = Array.isArray(taskFromCloud.participants) ? taskFromCloud.participants : [];
                if (participants.some(p => p?.uid === myId)) {
                    showToast("你已在该任务中", "error");
                    setIsJoinModalOpen(false);
                    return;
                }

                const nextParticipants = [...participants, { uid: myId, email: user?.email || 'User', status: 'pending' }];
                const { error: updateError } = await supabase.from(TASKS_TABLE).update({ participants: nextParticipants }).eq('id', taskFromCloud.id);
                if (updateError) {
                    console.error('Join task update error:', updateError);
                    showToast(`加入失败：${updateError.message}`, "error");
                    return;
                }

                const updatedTask = { ...taskFromCloud, participants: nextParticipants };
                setTasks(prev => {
                    const exists = prev.some(t => t.id === updatedTask.id);
                    return exists ? prev.map(t => t.id === updatedTask.id ? updatedTask : t) : [updatedTask, ...prev];
                });

                showToast("成功加入任务");
                setIsJoinModalOpen(false);
                setJoinCode('');
                return;
            }

            // Local mode demo fallback (no cloud)
            const taskFound = tasks.find(t => t.share_code === code);
            if (taskFound) {
                const myId = 'local_user';
                if (taskFound.participants.some(p => p.uid === myId)) {
                    showToast("你已在该任务中", "error");
                    return;
                }
                setTasks(prev => prev.map(t => {
                    if (t.id === taskFound.id) {
                        return { ...t, participants: [...t.participants, { uid: myId, email: 'Me', status: 'pending' }] };
                    }
                    return t;
                }));
                showToast("成功加入任务");
                setIsJoinModalOpen(false);
                setJoinCode('');
            } else {
                showToast("无效的邀请码（请先登录同步或由对方发起人创建任务）", "error");
            }
        };

        const deleteTask = (id) => {
            if(confirm("删除此任务？")) {
                setTasks(prev => prev.filter(t => t.id !== id));
                if (user?.id) void deleteTaskCloud(id);
                if (isModalOpen) setIsModalOpen(false);
                if (isDetailModalOpen) setIsDetailModalOpen(false);
            }
        };

        const removeParticipant = (taskId, uid) => {
            if (!confirm("确定移除该成员？")) return;
            setTasks(prev => {
                let updatedTask = null;
                const next = prev.map(t => {
                    if (t.id !== taskId) return t;
                    const participants = Array.isArray(t.participants) ? t.participants : [];
                    updatedTask = { ...t, participants: participants.filter(p => p.uid !== uid) };
                    return updatedTask;
                });
                if (updatedTask) {
                    if (detailTask?.id === taskId) setDetailTask(updatedTask);
                    if (user?.id) Promise.resolve().then(() => upsertTaskCloud(updatedTask));
                }
                return next;
            });
        };

        const regenerateCode = (taskId) => {
            const newCode = generateShareCode();
            setTasks(prev => {
                let updatedTask = null;
                const next = prev.map(t => {
                    if (t.id !== taskId) return t;
                    updatedTask = { ...t, share_code: newCode };
                    return updatedTask;
                });
                if (updatedTask && user?.id) Promise.resolve().then(() => upsertTaskCloud(updatedTask));
                return next;
            });
            if (detailTask) setDetailTask(prev => ({ ...prev, share_code: newCode }));
            showToast("邀请码已重置");
        };

        const copyInviteLink = (code) => {
            const link = window.location.href.split('?')[0] + '?join=' + code;
            navigator.clipboard.writeText(link);
            showToast("邀请链接已复制");
        };

        // UI Helpers
        const isTaskCompleted = (t) => {
            if (t.type === 'periodic') return t.completed_dates?.includes(new Date().toDateString());
            if (t.kind === 'multi') return false; 
            return t.completed;
        };

        const getMultiProgress = (t) => {
            if (!t.participants || t.participants.length === 0) return 0;
            const doneCount = t.participants.filter(p => p.status === 'done').length;
            return Math.round((doneCount / t.participants.length) * 100);
        };

        // Render Lists
        const filteredTasks = tasks.filter(t => (t.mode === mode) || (!t.mode && mode === 'life'));
        const inboxTasks = filteredTasks.filter(t => t.status === 'inbox' && !isTaskCompleted(t));
        const scheduledTasks = filteredTasks.filter(t => t.status === 'scheduled' && t.day === activeDay).sort((a,b) => a.startTime.localeCompare(b.startTime));

        const activeTabClass = mode === 'tutor' ? 'bg-craft-black text-craft-yellow border-craft-black' : 'bg-white text-black border-blue-200 ring-1 ring-blue-100';

        // Drag & Drop Handlers (Updated)
        const handleDragStart = (e, task) => {
            e.dataTransfer.setData('text/plain', JSON.stringify(task));
            e.dataTransfer.effectAllowed = 'move';
            // Important for mobile feedback
            if (navigator.vibrate) navigator.vibrate(10);
        };

        const handleDrop = (e, targetDay) => {
            e.preventDefault();
            setDragOverDay(null);
            try {
                const dataStr = e.dataTransfer.getData('text/plain');
                if (!dataStr) return;
                const data = JSON.parse(dataStr);
                
                // If dropping same day, do nothing or reorder (not implemented)
                if (data.day === targetDay && data.status === 'scheduled') return;

                // Move Logic
                const updatedTask = { ...data, status: 'scheduled', day: targetDay, startTime: '09:00' };
                
                // Open edit modal to confirm time
                setEditingTask(updatedTask);
                setFormData(updatedTask);
                setIsModalOpen(true);
                
                if (navigator.vibrate) navigator.vibrate(20);
            } catch(err) {
                console.error("Drop error", err);
            }
        };

        if (showLogin) return <LoginView onLoginSuccess={handleLoginSuccess} />;

        return (
            <div className="h-screen w-full flex flex-col bg-[#f5f5f7] text-[#1d1d1f] overflow-hidden select-none font-sans">
                
                {focusTask && <FocusView task={focusTask} onClose={() => setFocusTask(null)} onComplete={() => { toggleTaskState(focusTask); setFocusTask(null); showToast("任务完成"); }} />}

                {/* Header */}
                <header className="h-14 flex items-center justify-between px-5 bg-white/80 backdrop-blur-md border-b border-gray-200 shrink-0 safe-top z-40">
                    <div className="flex items-center gap-3">
                        <CraftLogo />
                        <h1 className="font-bold text-lg tracking-tight">LifeCraft</h1>
                    </div>
                    <div className="flex items-center gap-3">
                        {mode === 'tutor' && <div className="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2"><span className="text-[10px] font-bold text-yellow-600 uppercase tracking-wider">Tutor Mode</span></div>}
                        <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-gray-400 hover:text-black transition-colors"><Icon name="settings" size={20} /></button>
                    </div>
                </header>

                {/* Main Body */}
                <div className="flex-1 relative flex flex-col md:flex-row overflow-hidden">
                    {/* Schedule */}
                    <main className={`flex-1 flex flex-col overflow-hidden transition-all duration-300 ${isMobile && isInboxOpen ? 'h-[60%] border-b border-gray-200' : 'h-full'}`}>
                        <div className="px-4 py-3 flex items-center gap-2 overflow-x-auto no-scrollbar shrink-0">
                            {WEEK_DAYS.map(day => (
                                <button key={day.key} onClick={() => setActiveDay(day.key)}
                                    className={`flex-1 min-w-[60px] py-2 rounded-xl text-xs font-bold transition-all border ${activeDay === day.key ? activeTabClass + ' shadow-md scale-105' : 'bg-white text-gray-500 border-gray-200'}`}>
                                    {day.label}
                                </button>
                            ))}
                        </div>

                        <div 
                            className={`flex-1 overflow-y-auto p-4 transition-colors ${dragOverDay === activeDay ? 'drag-over' : ''}`}
                            onDragOver={(e) => { e.preventDefault(); setDragOverDay(activeDay); }}
                            onDragLeave={() => setDragOverDay(null)}
                            onDrop={(e) => handleDrop(e, activeDay)}
                        >
                            <div className="space-y-3 min-h-[300px]">
                                {scheduledTasks.length === 0 && (
                                    <div className="flex flex-col items-center justify-center h-40 opacity-30 gap-2 border-2 border-dashed border-gray-200 rounded-2xl">
                                        <Icon name="calendar-plus" size={32} className="text-gray-400" />
                                        <p className="text-xs text-gray-500">无安排</p>
                                    </div>
                                )}
                                {scheduledTasks.map(task => {
                                    const isMulti = task.kind === 'multi';
                                    const isPeriodic = task.type === 'periodic';
                                    const done = isTaskCompleted(task);
                                    const myId = user?.id || 'local_user';
                                    const amIDone = isMulti && task.participants.find(p=>p.uid === myId)?.status === 'done';
                                    const progress = isMulti ? getMultiProgress(task) : (done ? 100 : 0);

                                    return (
                                        <div key={task.id} 
                                            onClick={() => { if(isMulti) { setDetailTask(task); setIsDetailModalOpen(true); } else { setEditingTask(task); setFormData({...task}); setIsModalOpen(true); } }}
                                            className={`group bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-3 transition-all cursor-pointer hover:shadow-md active:scale-[0.98] relative overflow-hidden`}
                                        >
                                            {isMulti && <div className="absolute bottom-0 left-0 h-1 bg-blue-100 w-full"><div className="h-full bg-blue-500 transition-all duration-500" style={{ width: `${progress}%` }}></div></div>}

                                            <button onClick={(e) => { e.stopPropagation(); toggleTaskState(task); }} className={`w-6 h-6 rounded-full border flex items-center justify-center transition-all shrink-0 ${done || amIDone ? 'bg-black border-black text-craft-yellow' : 'border-gray-300 text-transparent hover:border-black'}`}>
                                                <Icon name="check" size={14} strokeWidth={3} />
                                            </button>
                                            
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <p className={`font-bold text-sm ${done ? 'line-through text-gray-400' : 'text-craft-black'}`}>{task.title}</p>
                                                    {isPeriodic && <Icon name="repeat" size={12} className="text-gray-400" />}
                                                    {isMulti && <Icon name="users" size={12} className="text-blue-500" />}
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] text-gray-400 font-mono flex items-center gap-1"><Icon name="clock" size={10}/> {task.startTime}</span>
                                                    {isMulti && <span className="text-[10px] text-blue-500 font-bold bg-blue-50 px-1.5 rounded">{progress}% Done</span>}
                                                </div>
                                            </div>
                                            
                                            {!isMulti && <button onClick={(e) => { e.stopPropagation(); setFocusTask(task); }} className="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:bg-black hover:text-white transition-all"><Icon name="play" size={14} fill="currentColor"/></button>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </main>

                    {/* Inbox */}
                    <aside className={`bg-white flex flex-col shadow-[0_-8px_30px_rgba(0,0,0,0.12)] transition-all duration-300 z-30 ${isMobile ? `fixed bottom-0 left-0 right-0 rounded-t-[32px] border-t border-gray-100 safe-bottom ${isInboxOpen ? 'h-[40%]' : 'h-0 translate-y-full'}` : 'w-80 border-l border-gray-200 h-full'}`}>
                        {isMobile && <div className="w-full flex justify-center py-3 cursor-pointer md:hidden" onClick={() => setIsInboxOpen(false)}><div className="w-12 h-1.5 bg-gray-300 rounded-full"></div></div>}
                        
                        <div className="px-5 pb-3 md:pt-5 border-b border-gray-50 flex justify-between items-center shrink-0">
                            <h3 className="font-bold flex items-center gap-2 text-lg">
                                <span className={`w-2 h-6 rounded-full ${mode === 'tutor' ? 'bg-craft-yellow' : 'bg-craft-blue'}`}></span>
                                待办箱 <span className="text-xs font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-500">{inboxTasks.length}</span>
                            </h3>
                            <button onClick={() => { setEditingTask(null); setFormData({ type: 'one-off', kind: 'single' }); setIsModalOpen(true); }} className="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center shadow active:scale-95"><Icon name="plus" size={18} /></button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-[#fbfbfb]">
                            {inboxTasks.map(task => (
                                <div 
                                    key={task.id} 
                                    draggable="true" 
                                    onDragStart={(e) => handleDragStart(e, task)} 
                                    className="draggable-source bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between group active:scale-[0.98]"
                                >
                                    <div className="flex flex-col pointer-events-none">
                                        <span className="font-medium text-sm text-craft-black truncate">{task.title}</span>
                                        <div className="flex gap-2 mt-1">
                                            {task.type === 'periodic' && <Icon name="repeat" size={12} className="text-gray-400" />}
                                            {task.kind === 'multi' && <Icon name="users" size={12} className="text-blue-500" />}
                                        </div>
                                    </div>
                                    <button onClick={() => deleteTask(task.id)} className="text-gray-300 hover:text-red-500 p-1"><Icon name="trash-2" size={14} /></button>
                                </div>
                            ))}
                        </div>
                    </aside>

                    {/* FAB */}
                    {isMobile && !isInboxOpen && (
                        <div className="fixed bottom-8 right-6 z-50 safe-bottom">
                            <button onClick={() => setIsInboxOpen(true)} className="h-14 w-14 bg-craft-black text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-105 active:scale-95 transition-transform border border-white/10">
                                <div className="relative">
                                    <Icon name="inbox" size={24} className={mode === 'tutor' ? 'text-craft-yellow' : 'text-white'} />
                                    {inboxTasks.length > 0 && <span className="absolute -top-2 -right-2 w-4 h-4 bg-red-500 rounded-full border-2 border-[#171717]"></span>}
                                </div>
                            </button>
                        </div>
                    )}
                </div>

                {/* --- Add/Edit Task Modal --- */}
                {isModalOpen && (
                    <div className="fixed inset-0 z-[60] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in" onClick={() => setIsModalOpen(false)}>
                        <div className="bg-white w-full max-w-sm rounded-[24px] shadow-2xl overflow-hidden p-6 animate-slide-up mb-safe-bottom" onClick={e => e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-4">{editingTask ? '编辑任务' : '新建任务'}</h3>
                            <form onSubmit={saveTask} className="space-y-4">
                                <input name="title" autoFocus required value={formData.title || ''} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-4 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-black font-medium text-lg placeholder-gray-300" placeholder="要做什么？" />
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button type="button" onClick={() => setFormData({...formData, type: formData.type === 'periodic' ? 'one-off' : 'periodic'})} className={`p-3 rounded-xl border text-xs font-bold flex items-center justify-center gap-2 ${formData.type === 'periodic' ? 'bg-black text-white border-black' : 'bg-white text-gray-500 border-gray-200'}`}>
                                        <Icon name="repeat" size={14}/> 周期循环
                                    </button>
                                    <button type="button" onClick={() => setFormData({...formData, kind: formData.kind === 'multi' ? 'single' : 'multi'})} className={`p-3 rounded-xl border text-xs font-bold flex items-center justify-center gap-2 ${formData.kind === 'multi' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200'}`}>
                                        <Icon name="users" size={14}/> 多人协作
                                    </button>
                                </div>

                                <div className="flex gap-3 pt-2">
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-3 rounded-xl bg-gray-100 font-bold text-gray-500 text-sm">取消</button>
                                    <button type="submit" className={`flex-1 py-3 rounded-xl font-bold text-sm shadow-lg ${mode === 'tutor' ? 'bg-craft-yellow text-black' : 'bg-craft-blue text-white'}`}>保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                )}

                {/* --- Multiplayer Detail Modal --- */}
                {isDetailModalOpen && detailTask && (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm p-6 animate-fade-in" onClick={() => setIsDetailModalOpen(false)}>
                        <div className="bg-white w-full max-w-sm rounded-[32px] shadow-2xl p-6 relative" onClick={e => e.stopPropagation()}>
                            <button onClick={() => setIsDetailModalOpen(false)} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-black"><Icon name="x" /></button>
                            
                            <div className="text-center mb-6">
                                <div className="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-blue-50 text-blue-600 mb-3"><Icon name="users" size={32} /></div>
                                <h3 className="text-xl font-black text-craft-black">{detailTask.title}</h3>
                                <div className="text-xs text-gray-400 font-mono mt-1">CODE: {detailTask.share_code}</div>
                            </div>

                            <div className="bg-gray-50 rounded-2xl p-4 mb-4 border border-gray-100">
                                <div className="flex justify-between items-center text-xs font-bold text-gray-500 mb-2">
                                    <span>Team Progress</span>
                                    <span>{getMultiProgress(detailTask)}%</span>
                                </div>
                                <div className="h-3 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-blue-500 animate-progress-stripes striped-bar" style={{ width: `${getMultiProgress(detailTask)}%` }}></div>
                                </div>
                            </div>

                            <div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar mb-4">
                                {detailTask.participants.map(p => (
                                    <div key={p.uid} className="flex items-center justify-between p-2 rounded-lg bg-white border border-gray-100">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-2 h-2 rounded-full ${p.status === 'done' ? 'bg-green-500' : 'bg-gray-300'}`}></div>
                                            <span className="text-xs font-bold text-gray-600">{p.email.split('@')[0]}</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            {p.status === 'done' && <Icon name="check" size={14} className="text-green-500"/>}
                                            {detailTask.owner_id === (user?.id || 'local_user') && p.uid !== detailTask.owner_id && (
                                                <button onClick={() => removeParticipant(detailTask.id, p.uid)} className="text-red-400 hover:text-red-600"><Icon name="x-circle" size={14}/></button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="flex flex-col gap-2">
                                <div className="flex gap-2">
                                    <button onClick={() => { navigator.clipboard.writeText(detailTask.share_code); showToast("邀请码已复制"); }} className="flex-1 py-3 bg-gray-100 text-black rounded-xl font-bold text-sm">复制邀请码</button>
                                    <button onClick={() => copyInviteLink(detailTask.share_code)} className="flex-1 py-3 bg-craft-black text-white rounded-xl font-bold text-sm shadow-md active:scale-95">复制链接</button>
                                </div>
                                {detailTask.owner_id === (user?.id || 'local_user') && (
                                    <button onClick={() => regenerateCode(detailTask.id)} className="text-xs text-gray-400 font-bold py-2 hover:text-blue-500">重置邀请码</button>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* --- Join Modal --- */}
                {isJoinModalOpen && (
                    <div className="fixed inset-0 z-[65] flex items-center justify-center bg-black/40 backdrop-blur-sm p-6" onClick={() => setIsJoinModalOpen(false)}>
                        <div className="bg-white w-full max-w-sm rounded-[24px] p-6" onClick={e => e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-4">加入协作任务</h3>
                            <input value={joinCode} onChange={e => setJoinCode(e.target.value.toUpperCase())} placeholder="输入邀请码 (如 LC-9X2Y)" className="w-full p-4 bg-gray-50 border rounded-xl font-mono text-center tracking-widest text-lg mb-4 uppercase focus:border-black outline-none" />
                            <button onClick={joinTask} disabled={!joinCode} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">加入团队</button>
                        </div>
                    </div>
                )}

                {/* Settings Modal */}
                {isSettingsOpen && (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in" onClick={() => setIsSettingsOpen(false)}>
                        <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl space-y-4" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-center border-b border-gray-100 pb-4">
                                <h3 className="font-bold text-lg">设置</h3>
                                <button onClick={() => setIsSettingsOpen(false)}><Icon name="x" /></button>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-xl flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-craft-black font-bold border border-gray-200">{user?.email?.[0]?.toUpperCase() || 'U'}</div>
                                    <div className="flex flex-col"><span className="text-xs font-bold text-gray-900">{user?.email || '本地用户'}</span><span className="text-[10px] text-gray-400">{user ? '已登录' : '未同步'}</span></div>
                                </div>
                                {user ? (
                                    <button onClick={handleSignOut} className="text-xs font-bold text-gray-400 hover:text-black">退出</button>
                                ) : (
                                    <button onClick={() => { setIsSettingsOpen(false); setShowLogin(true); }} className="text-xs font-bold text-blue-600 hover:text-blue-700">登录</button>
                                )}
                            </div>

                            <button onClick={() => setIsJoinModalOpen(true)} className="w-full p-4 bg-blue-50 text-blue-600 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition-colors">
                                <Icon name="user-plus" size={18}/> 输入邀请码加入任务
                            </button>

                            <div className="space-y-2 pt-2">
                                <label className="text-xs font-bold text-gray-400 uppercase">模式切换</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setMode('life')} className={`p-3 rounded-xl border flex items-center justify-center gap-2 ${mode === 'life' ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200'}`}><Icon name="coffee" size={16}/> Life</button>
                                    <button onClick={() => setMode('tutor')} className={`p-3 rounded-xl border flex items-center justify-center gap-2 ${mode === 'tutor' ? 'border-yellow-500 bg-yellow-50 text-yellow-700' : 'border-gray-200'}`}><Icon name="graduation-cap" size={16}/> Tutor</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {toast && (
                    <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[100] animate-fade-in px-6">
                        <div className={`px-4 py-2.5 rounded-full shadow-xl flex items-center gap-2 text-sm font-bold ${toast.type === 'error' ? 'bg-red-500 text-white' : 'bg-craft-black text-white'}`}>
                            <Icon name={toast.type === 'error' ? 'alert-circle' : 'check-circle'} size={16} />
                            {toast.msg}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  <script src="pwa.js"></script>
</body>
</html>
