<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WeatherCraft - 星际气象工坊</title>

  <!-- PWA -->
  <meta name="theme-color" content="#171717" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Craft" />
  
  <!-- 核心依赖 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- 配置 Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            craft: {
              black: '#000000',
              dark: '#111111',
              gray: '#262626',
              light: '#f5f5f5',
              white: '#ffffff',
              yellow: '#facc15', 
            }
          },
          animation: {
            'float': 'float 8s ease-in-out infinite',
            'warp-out': 'warpOut 0.8s cubic-bezier(0.7, 0, 0.84, 0) forwards',
            'warp-in': 'warpIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'star-pass': 'starPass 0.8s linear infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-15px)' }
            },
            warpOut: {
              '0%': { transform: 'scale(1) translateZ(0)', opacity: '1', filter: 'blur(0)' },
              '100%': { transform: 'scale(0.5) translateZ(-1000px)', opacity: '0', filter: 'blur(20px)' }
            },
            warpIn: {
              '0%': { transform: 'scale(1.5) translateZ(1000px)', opacity: '0', filter: 'blur(20px)' },
              '100%': { transform: 'scale(1) translateZ(0)', opacity: '1', filter: 'blur(0)' }
            },
            starPass: {
              '0%': { transform: 'translateX(100vw) translateY(-100vh)', opacity: '0' },
              '50%': { opacity: '1' },
              '100%': { transform: 'translateX(-100vw) translateY(100vh)', opacity: '0' }
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'Menlo', 'monospace'],
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
    
    body { font-family: 'Inter', sans-serif; overflow-x: hidden; background: #000; color: #fff; perspective: 1000px; }
    ::-webkit-scrollbar { display: none; } 

    /* 背景风格 */
    .bg-day { 
        background: #ffffff;
        color: #0a0a0a;
    }
    .bg-night { 
        background: #0a0a0a;
        color: #ffffff;
    }

    /* 磨砂玻璃与卡片 */
    .glass-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 24px;
        transition: all 0.3s ease;
    }
    .bg-day .glass-card {
        background: #f5f5f5;
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.02);
    }
    
    /* 悬停效果 */
    .glass-card:hover {
        transform: translateY(-2px);
        border-color: rgba(250, 204, 21, 0.3); /* Yellow Tint */
    }

    /* 加载动画 */
    .loader {
        width: 32px; height: 32px;
        border: 2px solid rgba(128,128,128,0.2);
        border-top-color: #facc15;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* 跃迁星空背景特效 */
    .warp-stars {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.3s;
    }
    .warp-stars.active { opacity: 1; }
    .star {
        position: absolute; width: 2px; height: 100px; background: rgba(255,255,255,0.8);
        transform: rotate(45deg);
        animation: starPass 0.5s linear infinite;
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useLayoutEffect, useMemo } = React;

    // --- 图标组件 ---
    const Icon = ({ name, size = 20, className = "" }) => {
      const ref = useRef(null);
      useLayoutEffect(() => {
        if (ref.current) {
            ref.current.innerHTML = '';
            const i = document.createElement('i');
            i.setAttribute('data-lucide', name);
            i.setAttribute('width', size);
            i.setAttribute('height', size);
            if (className) i.setAttribute('class', className);
            ref.current.appendChild(i);
            lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide' });
        }
      }, [name, size, className]);
      return <span ref={ref} className="inline-flex items-center justify-center"></span>;
    };

    // --- 省市数据 (层级结构) ---
    const CITY_DATA = [
        { 
            province: "热门城市", 
            cities: [
                { name: "北京", lat: 39.9042, lon: 116.4074 },
                { name: "上海", lat: 31.2304, lon: 121.4737 },
                { name: "广州", lat: 23.1291, lon: 113.2644 },
                { name: "深圳", lat: 22.5431, lon: 114.0579 },
                { name: "杭州", lat: 30.2741, lon: 120.1551 },
                { name: "成都", lat: 30.5728, lon: 104.0668 }
            ]
        },
        {
            province: "华北",
            cities: [
                { name: "天津", lat: 39.0842, lon: 117.2009 },
                { name: "石家庄", lat: 38.0428, lon: 114.5149 },
                { name: "太原", lat: 37.8706, lon: 112.5489 },
                { name: "呼和浩特", lat: 40.8415, lon: 111.7492 }
            ]
        },
        {
            province: "华东",
            cities: [
                { name: "南京", lat: 32.0603, lon: 118.7969 },
                { name: "苏州", lat: 31.2989, lon: 120.5853 },
                { name: "合肥", lat: 31.8206, lon: 117.2272 },
                { name: "福州", lat: 26.0745, lon: 119.2965 },
                { name: "南昌", lat: 28.6820, lon: 115.8579 },
                { name: "济南", lat: 36.6512, lon: 117.1201 },
                { name: "青岛", lat: 36.0671, lon: 120.3826 }
            ]
        },
        {
            province: "华中/华南",
            cities: [
                { name: "郑州", lat: 34.7466, lon: 113.6253 },
                { name: "武汉", lat: 30.5928, lon: 114.3055 },
                { name: "长沙", lat: 28.2282, lon: 112.9388 },
                { name: "南宁", lat: 22.8170, lon: 108.3665 },
                { name: "海口", lat: 20.0174, lon: 110.3492 }
            ]
        },
        {
            province: "西部",
            cities: [
                { name: "重庆", lat: 29.5630, lon: 106.5516 },
                { name: "昆明", lat: 24.8801, lon: 102.8329 },
                { name: "贵阳", lat: 26.6470, lon: 106.6302 },
                { name: "拉萨", lat: 29.6525, lon: 91.1721 },
                { name: "西安", lat: 34.3416, lon: 108.9398 },
                { name: "兰州", lat: 36.0611, lon: 103.8343 },
                { name: "乌鲁木齐", lat: 43.8256, lon: 87.6168 }
            ]
        },
        {
            province: "东北",
            cities: [
                { name: "沈阳", lat: 41.8057, lon: 123.4315 },
                { name: "长春", lat: 43.8171, lon: 125.3235 },
                { name: "哈尔滨", lat: 45.8038, lon: 126.5349 },
                { name: "大连", lat: 38.9140, lon: 121.6147 }
            ]
        }
    ];

    // --- 天气配置 (黑白风格) ---
    const getWeatherConfig = (code, isDay = true) => {
        if (code === undefined) return { name: '加载中', icon: 'loader' };
        
        const base = { isDay };
        if (code === 0) return { ...base, name: isDay ? '晴朗' : '晴夜', icon: isDay ? 'sun' : 'moon' };
        if ([1, 2, 3].includes(code)) return { ...base, name: '多云', icon: isDay ? 'cloud' : 'cloud-moon' };
        if ([45, 48].includes(code)) return { ...base, name: '雾霾', icon: 'cloud-fog' };
        if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return { ...base, name: '降雨', icon: 'cloud-rain' };
        if ([71, 73, 75, 77, 85, 86].includes(code)) return { ...base, name: '降雪', icon: 'snowflake' };
        if ([95, 96, 99].includes(code)) return { ...base, name: '雷暴', icon: 'cloud-lightning' };
        return { ...base, name: '阴天', icon: 'cloud' };
    };

    const getAqiLevel = (aqi) => {
        if (!aqi) return { label: '-', color: 'text-gray-500' };
        if (aqi <= 50) return { label: '优', color: 'text-green-500' };
        if (aqi <= 100) return { label: '良', color: 'text-craft-yellow' };
        if (aqi <= 150) return { label: '轻度', color: 'text-orange-500' };
        return { label: '污染', color: 'text-red-500' };
    };

    // --- 主应用 ---
    function App() {
        const [weather, setWeather] = useState(null);
        const [loading, setLoading] = useState(true);
        const [location, setLocation] = useState({ name: '北京', lat: 39.9042, lon: 116.4074 });
        
        const [isSearchOpen, setIsSearchOpen] = useState(false);
        const [isExporting, setIsExporting] = useState(false);
        const [animationClass, setAnimationClass] = useState("animate-warp-in"); // 初始进入动画
        const [toast, setToast] = useState({ show: false, msg: '' });
        
        // Search State
        const [activeTab, setActiveTab] = useState(0); // 0: 热门, ...
        const [searchTerm, setSearchTerm] = useState("");

        const appRef = useRef(null);

        // 数据获取
        const fetchData = async () => {
            // 开始跃迁 (Warp Out)
            setAnimationClass("animate-warp-out");
            
            // 模拟飞船飞行时间，并在飞行中加载数据
            setTimeout(async () => {
                setLoading(true);
                try {
                    const [weatherRes, aqiRes] = await Promise.all([
                        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.lat}&longitude=${location.lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,surface_pressure,visibility,precipitation&hourly=temperature_2m,weather_code,precipitation_probability,uv_index&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_sum&timezone=auto`),
                        fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${location.lat}&longitude=${location.lon}&current=us_aqi,pm10,pm2_5,nitrogen_dioxide,sulphur_dioxide,ozone`)
                    ]);

                    const weatherData = await weatherRes.json();
                    const aqiData = await aqiRes.json();

                    setWeather({ ...weatherData, aqi: aqiData.current });
                } catch (error) {
                    console.error(error);
                    showToast("数据获取失败");
                } finally {
                    setLoading(false);
                    // 到达目的地 (Warp In)
                    setAnimationClass("animate-warp-in");
                }
            }, 800); // 飞行 800ms
        };

        useEffect(() => {
            fetchData();
        }, [location]);

        const showToast = (msg) => {
            setToast({ show: true, msg });
            setTimeout(() => setToast({ show: false, msg: '' }), 3000);
        };

        const handleExport = () => {
            setIsExporting(true);
            showToast("正在印制气象报纸...");
            const el = appRef.current;
            
            // 临时背景色，确保导出不透明
            const isDay = weather?.current?.is_day === 1;
            const bg = isDay ? '#ffffff' : '#0a0a0a';
            
            html2canvas(el, { scale: 2, useCORS: true, backgroundColor: bg }).then(canvas => {
                const link = document.createElement('a');
                link.download = `WeatherCraft_${location.name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#ffffff', '#facc15'] });
                showToast("报纸已发行");
            }).finally(() => setIsExporting(false));
        };

        // UI 渲染辅助
        const current = weather?.current;
        const daily = weather?.daily;
        const hourly = weather?.hourly;
        const aqi = weather?.aqi;
        
        const config = getWeatherConfig(current?.weather_code, current?.is_day === 1);
        const isDay = current?.is_day === 1;
        const themeClass = isDay ? 'bg-day' : 'bg-night';
        const aqiInfo = getAqiLevel(aqi?.us_aqi);

        // 扁平化搜索
        const allCities = useMemo(() => {
            return CITY_DATA.flatMap(group => group.cities);
        }, []);
        
        const filteredCities = useMemo(() => {
            if (!searchTerm) return [];
            return allCities.filter(c => c.name.includes(searchTerm));
        }, [searchTerm, allCities]);

        return (
            <div className={`min-h-screen relative font-sans selection:bg-craft-yellow selection:text-black ${themeClass} transition-colors duration-700`}>
                
                {/* 跃迁星空特效层 */}
                <div className={`warp-stars ${animationClass === 'animate-warp-out' || loading ? 'active' : ''}`}>
                    {[...Array(20)].map((_, i) => (
                        <div key={i} className="star" style={{ 
                            left: `${Math.random() * 100}%`, 
                            top: `${Math.random() * 100}%`, 
                            animationDelay: `${Math.random() * 0.5}s`,
                            opacity: loading ? 1 : 0
                        }}></div>
                    ))}
                </div>

                {/* 顶部导航 */}
                <header className="fixed top-0 w-full h-16 px-6 flex items-center justify-between z-50 backdrop-blur-md border-b border-gray-500/10">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-lg bg-craft-yellow text-black flex items-center justify-center shadow-lg font-bold text-xl">W</div>
                        <h1 className="text-lg font-bold tracking-tight">WeatherCraft</h1>
                    </div>
                    <div className="flex items-center gap-4">
                        <button 
                            onClick={() => setIsSearchOpen(true)}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all ${isDay ? 'border-black/10 hover:bg-black/5' : 'border-white/10 hover:bg-white/10'}`}
                        >
                            <Icon name="map-pin" size={14} />
                            <span className="text-sm font-bold tracking-wide">{location.name}</span>
                            <Icon name="chevron-down" size={14} />
                        </button>
                        <button onClick={handleExport} className={`p-2 rounded-full transition-colors ${isDay ? 'hover:bg-black/5' : 'hover:bg-white/10'}`} title="生成气象报纸">
                            <Icon name="printer" size={18} />
                        </button>
                    </div>
                </header>

                {/* 主内容区 (应用跃迁动画) */}
                <div ref={appRef} className={`pt-24 pb-12 px-4 md:px-8 max-w-7xl mx-auto min-h-screen flex flex-col ${animationClass}`}>
                    
                    <div className="w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* 左侧：今日核心 (4 cols) */}
                        <div className="lg:col-span-4 flex flex-col gap-6">
                            {/* 主卡片 */}
                            <div className="glass-card p-8 relative overflow-hidden group min-h-[420px] flex flex-col justify-between">
                                <div>
                                    <div className="flex justify-between items-start">
                                        <span className="text-xs font-mono opacity-60 tracking-widest">{new Date().toLocaleDateString('en-US', { weekday: 'long', day: 'numeric' }).toUpperCase()}</span>
                                        <div className={`px-2 py-0.5 rounded text-[10px] font-bold border ${isDay ? 'border-black/10 text-black/60' : 'border-white/20 text-white/60'}`}>NOW</div>
                                    </div>
                                    <h2 className="text-5xl font-black mt-4 tracking-tighter">{config.name}</h2>
                                </div>

                                <div className="flex-1 flex items-center justify-center my-8">
                                    <div className="animate-float scale-150">
                                        <Icon name={config.icon} size={100} strokeWidth={1} />
                                    </div>
                                </div>

                                <div>
                                    <div className="text-8xl font-black tracking-tighter leading-none">{Math.round(current?.temperature_2m)}°</div>
                                    <div className="mt-4 flex items-center gap-4 text-sm font-medium opacity-60">
                                        <span>H: {Math.round(daily?.temperature_2m_max[0])}°</span>
                                        <span>L: {Math.round(daily?.temperature_2m_min[0])}°</span>
                                        <span className={`${aqiInfo.color}`}>AQI {aqi?.us_aqi}</span>
                                    </div>
                                </div>
                            </div>

                            {/* 生活指数 Grid */}
                            <div className="grid grid-cols-2 gap-4">
                                <IndexCard icon="shirt" label="穿衣" value={current?.temperature_2m < 15 ? '保暖' : '舒适'} sub="Life Style" isDay={isDay} />
                                <IndexCard icon="sun" label="紫外线" value={daily?.uv_index_max[0]} sub={daily?.uv_index_max[0]>5?'强':'弱'} isDay={isDay} />
                                <IndexCard icon="wind" label="风速" value={current?.wind_speed_10m} unit="km/h" isDay={isDay} />
                                <IndexCard icon="droplets" label="湿度" value={current?.relative_humidity_2m} unit="%" isDay={isDay} />
                            </div>
                        </div>

                        {/* 右侧：详细数据 (8 cols) */}
                        <div className="lg:col-span-8 flex flex-col gap-6">
                            
                            {/* 24小时趋势 */}
                            <div className="glass-card p-8">
                                <div className="flex items-center justify-between mb-6 opacity-50">
                                    <span className="text-xs font-bold uppercase tracking-widest flex items-center gap-2"><Icon name="clock" size={14}/> 24-Hour Forecast</span>
                                </div>
                                <div className="flex overflow-x-auto gap-8 pb-4 no-scrollbar">
                                    {hourly?.time.slice(new Date().getHours(), new Date().getHours() + 24).map((t, i) => {
                                        const hourIndex = new Date().getHours() + i;
                                        const temp = hourly.temperature_2m[hourIndex];
                                        const code = hourly.weather_code[hourIndex];
                                        const hourTime = new Date(t).getHours();
                                        const isNightHour = hourTime < 6 || hourTime > 18;
                                        const icon = getWeatherConfig(code, !isNightHour).icon;
                                        
                                        return (
                                            <div key={i} className="flex flex-col items-center gap-3 min-w-[50px] group cursor-default">
                                                <span className="text-xs font-mono opacity-40">{hourTime}:00</span>
                                                <div className={`p-2 rounded-xl transition-colors ${isDay ? 'group-hover:bg-black/5' : 'group-hover:bg-white/10'}`}>
                                                    <Icon name={icon} size={20} className="opacity-80" />
                                                </div>
                                                <span className="text-sm font-bold">{Math.round(temp)}°</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            {/* 太阳与空气 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* 日出日落可视化 */}
                                <div className="glass-card p-8 flex flex-col justify-between">
                                    <div className="opacity-50 mb-2">
                                        <span className="text-xs font-bold uppercase tracking-widest flex items-center gap-2"><Icon name="horizon" size={14}/> Sun Path</span>
                                    </div>
                                    <div className="relative h-28 mt-4">
                                        <div className={`absolute bottom-0 left-2 right-2 h-24 border-t-2 border-dashed rounded-t-full ${isDay ? 'border-black/10' : 'border-white/10'}`}></div>
                                        <div className="absolute bottom-0 left-0 -translate-x-1/2 text-center">
                                            <div className="text-[10px] font-mono opacity-60 mb-1">Sunrise</div>
                                            <div className="text-xs font-bold">{new Date(daily?.sunrise[0]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                                        </div>
                                        <div className="absolute bottom-0 right-0 translate-x-1/2 text-center">
                                            <div className="text-[10px] font-mono opacity-60 mb-1">Sunset</div>
                                            <div className="text-xs font-bold">{new Date(daily?.sunset[0]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                                        </div>
                                        {/* Sun Position Mock */}
                                        <div className="absolute left-1/2 top-0 -translate-x-1/2 -translate-y-1/2">
                                            <Icon name={isDay ? "sun" : "moon"} size={28} className={isDay ? "text-craft-yellow animate-pulse-slow" : "text-gray-400"} />
                                        </div>
                                    </div>
                                </div>

                                {/* 空气质量 */}
                                <div className="glass-card p-8 flex flex-col gap-4">
                                    <div className="flex justify-between items-start">
                                        <span className="text-xs font-bold uppercase tracking-widest opacity-50 flex items-center gap-2"><Icon name="wind" size={14}/> Air Quality</span>
                                        <span className={`text-xs font-bold px-2 py-0.5 rounded ${aqiInfo.color === 'text-green-500' ? 'bg-green-500/10' : 'bg-yellow-500/10'} ${aqiInfo.color}`}>
                                            {aqiInfo.label}
                                        </span>
                                    </div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-4xl font-black">{aqi?.us_aqi}</span>
                                        <span className="text-xs opacity-50 font-mono">US AQI</span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 mt-2">
                                        <AqiItem label="PM2.5" value={aqi?.pm2_5} isDay={isDay} />
                                        <AqiItem label="PM10" value={aqi?.pm10} isDay={isDay} />
                                        <AqiItem label="NO2" value={aqi?.nitrogen_dioxide} isDay={isDay} />
                                    </div>
                                </div>
                            </div>

                            {/* 7天预报 */}
                            <div className="glass-card p-8">
                                <div className="flex items-center gap-2 mb-4 opacity-50">
                                    <Icon name="calendar" size={16} />
                                    <span className="text-xs font-bold uppercase tracking-widest">7-Day Outlook</span>
                                </div>
                                <div className="space-y-3">
                                    {daily?.time.map((t, i) => (
                                        <div key={i} className={`flex items-center justify-between p-2 rounded-lg transition-colors cursor-default ${isDay ? 'hover:bg-black/5' : 'hover:bg-white/5'}`}>
                                            <span className="w-16 text-sm font-medium">{i === 0 ? 'Today' : new Date(t).toLocaleDateString('zh-CN', {weekday:'short'})}</span>
                                            <div className="flex items-center gap-3 w-32">
                                                <Icon name={getWeatherConfig(daily.weather_code[i]).icon} size={18} className="opacity-70" />
                                                <span className="text-xs opacity-50">{getWeatherConfig(daily.weather_code[i]).name}</span>
                                            </div>
                                            <div className="flex items-center gap-4 flex-1 justify-end">
                                                <span className="text-xs opacity-50 w-8 text-right">{Math.round(daily.temperature_2m_min[i])}°</span>
                                                <div className={`w-24 h-1.5 rounded-full overflow-hidden relative ${isDay ? 'bg-black/5' : 'bg-white/10'}`}>
                                                    <div className={`absolute h-full rounded-full opacity-80 ${isDay ? 'bg-black' : 'bg-white'}`} style={{ left: '15%', right: '15%' }}></div>
                                                </div>
                                                <span className="text-sm font-bold w-8 text-left">{Math.round(daily.temperature_2m_max[i])}°</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                {/* City Picker Modal */}
                {isSearchOpen && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-blur-in" onClick={() => setIsSearchOpen(false)}>
                        <div className={`rounded-3xl shadow-2xl w-full max-w-4xl h-[80vh] overflow-hidden flex flex-col animate-slide-up ${isDay ? 'bg-white text-black' : 'bg-[#111] text-white border border-white/10'}`} onClick={e => e.stopPropagation()}>
                            {/* Search Header */}
                            <div className={`p-6 border-b flex items-center gap-4 shrink-0 ${isDay ? 'border-gray-100' : 'border-white/10'}`}>
                                <Icon name="search" size={20} className="opacity-50" />
                                <input 
                                    type="text" 
                                    autoFocus
                                    placeholder="搜索城市 (中文/拼音)..." 
                                    className="flex-1 text-lg outline-none bg-transparent placeholder-opacity-40"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                                <button onClick={() => setIsSearchOpen(false)}><Icon name="x" className="opacity-50 hover:opacity-100 transition-opacity"/></button>
                            </div>
                            
                            <div className="flex flex-1 overflow-hidden">
                                {/* Left: Provinces (Only show if no search term) */}
                                {!searchTerm && (
                                    <div className={`w-32 overflow-y-auto border-r p-2 space-y-1 ${isDay ? 'border-gray-100' : 'border-white/5'}`}>
                                        {CITY_DATA.map((group, idx) => (
                                            <button 
                                                key={idx}
                                                onClick={() => setActiveTab(idx)}
                                                className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold transition-all ${activeTab === idx ? 'bg-craft-yellow text-black' : 'opacity-60 hover:opacity-100'}`}
                                            >
                                                {group.province}
                                            </button>
                                        ))}
                                    </div>
                                )}
                                
                                {/* Right: Cities */}
                                <div className={`flex-1 overflow-y-auto p-6 ${isDay ? 'bg-gray-50' : 'bg-white/5'}`}>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                                        {(searchTerm ? filteredCities : CITY_DATA[activeTab].cities).map(city => (
                                            <button 
                                                key={city.name}
                                                onClick={() => { setLocation(city); setIsSearchOpen(false); setSearchTerm(''); }}
                                                className={`p-4 rounded-xl text-sm font-bold transition-all text-center ${isDay ? 'bg-white hover:bg-black hover:text-white shadow-sm' : 'bg-white/5 hover:bg-white hover:text-black'}`}
                                            >
                                                {city.name}
                                            </button>
                                        ))}
                                        {searchTerm && filteredCities.length === 0 && (
                                            <p className="col-span-full text-center opacity-40 py-10">未找到城市</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* Toast */}
                <div className={`fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 bg-craft-yellow text-black rounded-full shadow-2xl z-[100] transition-all duration-300 flex items-center gap-2 ${toast.show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                    <Icon name="check" size={16} />
                    <span className="font-bold text-sm">{toast.msg}</span>
                </div>

            </div>
        );
    }

    // --- 子组件 ---
    const IndexCard = ({ icon, label, value, unit, isDay, sub }) => (
        <div className={`glass-card p-5 flex flex-col justify-between items-start gap-1 cursor-default`}>
            <div className="flex items-center gap-2 opacity-40 text-[10px] font-bold uppercase tracking-wider">
                <Icon name={icon} size={12} /> {label}
            </div>
            <div className="flex items-baseline gap-1 mt-1">
                <span className="text-xl font-bold">{value}</span>
                {unit && <span className="text-xs opacity-50 font-medium">{unit}</span>}
            </div>
            {sub && <div className="text-[10px] opacity-40 font-mono mt-1">{sub}</div>}
        </div>
    );

    const AqiItem = ({ label, value, isDay }) => (
        <div className={`flex flex-col p-2 rounded-lg ${isDay ? 'bg-black/5' : 'bg-white/5'}`}>
            <span className="text-[10px] opacity-40 font-bold">{label}</span>
            <span className="font-mono font-bold text-sm">{value || '-'}</span>
        </div>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <script src="pwa.js"></script>
</body>
</html>
